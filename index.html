<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Áç£ÂåªÁôÇ ÊïëÊÄ•ÁñæÊÇ£ÔºÜË®àÁÆó„ÉÑ„Éº„É´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .content-section h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            margin-top: 1.75rem; /* mt-7 */
            margin-bottom: 0.75rem; /* mb-3 */
            padding-bottom: 0.5rem; /* pb-2 */
            border-bottom: 2px solid #34d399; /* border-b-2 border-emerald-400 */
            color: #047857; /* text-emerald-700 */
        }
        .content-section ul { list-style-type: disc; padding-left: 1.75rem; margin-top: 0.5rem; }
        .content-section li { margin-bottom: 0.5rem; }
        
        /* Table styles */
        .table-container { overflow-x: auto; margin-top: 1rem; }
        .custom-table { width: 100%; border-collapse: collapse; }
        .custom-table th, .custom-table td { border: 1px solid #d1d5db; padding: 0.75rem; text-align: left; }
        .custom-table th { background-color: #f3f4f6; font-weight: 600; }
        .custom-table tr:nth-child(even) { background-color: #f9fafb; }

        /* Calculator styles */
        .calc-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .calc-input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }
        .calc-result-box {
            background-color: #f0fdfa; /* emerald-50 */
            border: 1px solid #a7f3d0; /* emerald-200 */
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1.5rem;
        }
        .calc-formula {
            background-color: #e5e7eb; /* gray-200 */
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.9rem;
        }
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex h-screen overflow-hidden">
        <nav id="sidebar" class="w-16 md:w-56 bg-gray-800 text-white flex flex-col transition-all duration-300 flex-shrink-0">
            <div class="px-4 py-5 border-b border-gray-700 flex items-center justify-center md:justify-start">
                <svg class="h-8 w-8 text-emerald-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-9-5.747h18"/>
                </svg>
                <h1 class="text-xl font-bold ml-3 hidden md:block">Vet Guide</h1>
            </div>
            <ul id="nav-list" class="flex-grow overflow-y-auto">
                </ul>
             <div class="px-4 py-3 border-t border-gray-700">
                <p class="text-xs text-gray-500 text-center hidden md:block">&copy; 2024 Vet Emergency Guide</p>
            </div>
        </nav>

        <main class="flex-1 flex overflow-hidden">
            <div id="list-panel" class="w-full md:w-1/4 lg:w-1/5 bg-white border-r border-gray-200 overflow-y-auto flex-shrink-0">
                 <div class="p-4 border-b border-gray-200 sticky top-0 bg-white z-10">
                    <h2 id="category-title" class="text-xl font-bold text-gray-700">„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû</h2>
                </div>
                <ul id="item-list">
                    </ul>
            </div>

            <div id="detail-panel" class="flex-1 overflow-y-auto p-6 md:p-8 lg:p-10">
                <div id="detail-content">
                    </div>
            </div>
        </main>
    </div>

    <script>
        // --- microCMS Configuration ---
        const MICROCMS_CONFIG = {
            apiKey: '66U37gIl7UHa9gJqv5OyV3OI6IbBh5Awu7jS',
            serviceDomain: 'vetinfo'
        };

        // --- SPA-Managed Data (Calculators) ---
        const calculatorDefinitions = {
            "Áä¨„ÉªÁå´": {
                "Ë®àÁÆó„ÉÑ„Éº„É´": {
                    "„Ç´„É≠„É™„ÉºË®àÁÆó (RER/DER)": { "type": "calculator", "id": "calorie_dogcat" },
                    "‰ΩìË°®Èù¢Á©ç (BSA)": { "type": "calculator", "id": "bsa" },
                    "Ëº∏Ë°ÄÈáèË®àÁÆó": { "type": "calculator", "id": "transfusion" },
                    "CRIË®àÁÆó (Œºg/kg/min)": { "type": "calculator", "id": "cri_gamma" },
                    "CRIË®àÁÆó (mg/kg/hr)": { "type": "calculator", "id": "cri_mg_hr" },
                    "CRIË®àÁÆó (Â∏åÈáà„Å™„Åó)": { "type": "calculator", "id": "cri_no_dilution" }
                }
            },
            "„Ç®„Ç≠„Çæ„ÉÅ„ÉÉ„ÇØ„Ç¢„Éã„Éû„É´": {
                 "Ë®àÁÆó„ÉÑ„Éº„É´": {
                    "ÁµåÂè£ÊäïËñ¨ÈáèË®àÁÆó": { "type": "calculator", "id": "medication_exotic_oral" },
                    "È£≤Ê∞¥ÊäïËñ¨ÈáèË®àÁÆó": { "type": "calculator", "id": "medication_exotic_water" }
                }
            }
        };

        // --- Global State ---
        let contentData = {}; // This will be populated from microCMS
        let activeMajorCategory = null;
        let activeSubCategory = null;
        let activeItem = null;

        // --- DOM Elements ---
        const navList = document.getElementById('nav-list');
        const categoryTitle = document.getElementById('category-title');
        const itemList = document.getElementById('item-list');
        const detailContent = document.getElementById('detail-content');

        // --- Data Fetching & Processing ---
        async function fetchMicroCMSData() {
            setLoading(detailContent);
            try {
                const response = await fetch(`https://${MICROCMS_CONFIG.serviceDomain}.microcms.io/api/v1/articles?limit=100&depth=2`, {
                    headers: { 'X-MICROCMS-API-KEY': MICROCMS_CONFIG.apiKey }
                });
                if (!response.ok) throw new Error(`API fetch failed: ${response.status}`);
                const data = await response.json();
                return processFetchedData(data.contents);
            } catch (error) {
                console.error("Failed to fetch from microCMS:", error);
                setError(detailContent, "„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
                return {};
            }
        }

        function processFetchedData(articles) {
            const processedData = {};
            articles.forEach(article => {
                const majorCat = article.animal_group?.group_name;
                const subCat = article.content_category?.category_name;
                if (!majorCat || !subCat) return;

                if (!processedData[majorCat]) processedData[majorCat] = {};
                if (!processedData[majorCat][subCat]) processedData[majorCat][subCat] = {};
                
                if (majorCat === "„Ç®„Ç≠„Çæ„ÉÅ„ÉÉ„ÇØ„Ç¢„Éã„Éû„É´" && subCat === "ÊïëÊÄ•ÁñæÊÇ£" && article.exotic_species) {
                    const species = article.exotic_species.species_name;
                    if (!processedData[majorCat][subCat][species]) {
                        processedData[majorCat][subCat][species] = {};
                    }
                    processedData[majorCat][subCat][species][article.title] = article;
                } else {
                    processedData[majorCat][subCat][article.title] = article;
                }
            });
            return processedData;
        }

        // --- Rendering Functions ---
        function renderNavigation() {
            navList.innerHTML = '';
            const majorCategories = { "Áä¨„ÉªÁå´": "üêæ", "„Ç®„Ç≠„Çæ„ÉÅ„ÉÉ„ÇØ„Ç¢„Éã„Éû„É´": "üêá" };
            
            Object.keys(majorCategories).forEach(cat => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <a href="#" class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors duration-200" data-major-category="${cat}">
                        <span class="w-8 text-center text-lg">${majorCategories[cat]}</span>
                        <span class="ml-3 hidden md:inline">${cat}</span>
                    </a>
                `;
                navList.appendChild(li);
            });
        }

        function renderSubCategoryList(majorCat) {
            categoryTitle.textContent = majorCat;
            const contentSubCats = contentData[majorCat] ? Object.keys(contentData[majorCat]) : [];
            const calcSubCats = calculatorDefinitions[majorCat] ? Object.keys(calculatorDefinitions[majorCat]) : [];
            const allSubCats = [...new Set([...contentSubCats, ...calcSubCats])]; // Use Set to remove duplicates

            itemList.innerHTML = allSubCats.map(subCat => `
                <li>
                    <a href="#" class="block px-4 py-3 text-gray-700 hover:bg-emerald-50 border-b border-gray-100" data-major-category="${majorCat}" data-sub-category="${subCat}">
                        ${subCat}
                    </a>
                </li>
            `).join('');
        }

        function renderItemList(majorCat, subCat, species = null) {
            let path = `${majorCat} > ${subCat}`;
            if (species) {
                path += ` > ${species}`;
            }
            categoryTitle.textContent = path;

            const isCalc = calculatorDefinitions[majorCat] && calculatorDefinitions[majorCat][subCat];
            let dataRoot = isCalc ? calculatorDefinitions[majorCat][subCat] : contentData[majorCat][subCat];
            if (species) {
                dataRoot = dataRoot[species];
            }
            const items = Object.keys(dataRoot);

            let listHtml = `<li><a href="#" class="block px-4 py-3 font-bold text-emerald-600 hover:bg-emerald-50 border-b border-gray-100" data-major-category="${majorCat}" data-sub-category="BACK" data-species="${species || ''}">‚Üê Êàª„Çã</a></li>`;
            
            listHtml += items.map(item => `
                <li>
                    <a href="#" class="block px-4 py-3 text-gray-700 hover:bg-emerald-50 border-b border-gray-100" data-major-category="${majorCat}" data-sub-category="${subCat}" data-item="${item}" data-species="${species || ''}">
                        ${item}
                    </a>
                </li>
            `).join('');
            itemList.innerHTML = listHtml;
        }
        
        function renderDetail(majorCat, subCat, itemName, species = null) {
            const isCalc = calculatorDefinitions[majorCat] && calculatorDefinitions[majorCat][subCat];
            let data;
            let titlePath = `${majorCat} > ${subCat}`;

            if (isCalc) {
                data = calculatorDefinitions[majorCat][subCat][itemName];
            } else {
                data = species ? contentData[majorCat][subCat][species][itemName] : contentData[majorCat][subCat][itemName];
                if (species) {
                    titlePath += ` > ${species}`;
                }
            }
            
            if (data.type === 'calculator') {
                renderCalculator(itemName, data.id);
                return;
            }

            let contentHtml = `<h2 class="text-3xl font-bold text-gray-800 mb-2">${data.title}</h2>`;
            contentHtml += `<p class="text-sm text-gray-500 mb-6">„Ç´„ÉÜ„Ç¥„É™: ${titlePath}</p>`;

            if (data.overview) {
                 contentHtml += `<div class="content-section"><h3>Ê¶ÇË¶Å</h3><p class="text-gray-700 leading-relaxed">${data.overview}</p></div>`;
            }
            if (data.body) {
                contentHtml += `<div class="content-section"><h3>Ë©≥Á¥∞</h3>${data.body}</div>`;
            }

            detailContent.innerHTML = contentHtml;
        }

        // --- UI State Functions ---
        function setWelcomeMessage() {
            detailContent.innerHTML = `
                <div class="text-center py-20">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" /></svg>
                    <h3 class="mt-2 text-lg font-medium text-gray-900">„Éá„Éº„Çø„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
                    <p class="mt-1 text-sm text-gray-500">Â∑¶„ÅÆ„É°„Éã„É•„Éº„Åã„Çâ„Ç´„ÉÜ„Ç¥„É™„Å®È†ÖÁõÆ„ÇíÈÅ∏Êäû„Åô„Çã„Å®„ÄÅ„Åì„Åì„Å´Ë©≥Á¥∞„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ</p>
                </div>`;
        }

        function setLoading(element) {
            element.innerHTML = '<div class="loader"></div>';
        }

        function setError(element, message) {
            element.innerHTML = `<div class="text-center py-20 text-red-600">${message}</div>`;
        }
        
        // --- Event Handlers ---
        navList.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (!link) return;
            e.preventDefault();

            const majorCat = link.dataset.majorCategory;
            if (activeMajorCategory === majorCat) return;

            activeMajorCategory = majorCat;
            activeSubCategory = null;
            activeItem = null;

            document.querySelectorAll('#nav-list a').forEach(a => a.classList.remove('bg-gray-700', 'text-white'));
            link.classList.add('bg-gray-700', 'text-white');

            renderSubCategoryList(majorCat);
            setWelcomeMessage();
        });

        itemList.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (!link) return;
            e.preventDefault();

            const majorCat = link.dataset.majorCategory;
            const subCat = link.dataset.subCategory;
            const itemName = link.dataset.item;
            const species = link.dataset.species;

            if (subCat === 'BACK') {
                if (species) { // Came from an article list under a species
                    renderItemList(majorCat, "ÊïëÊÄ•ÁñæÊÇ£");
                } else { // Came from a subcategory list (or species list)
                    activeSubCategory = null;
                    renderSubCategoryList(majorCat);
                }
                activeItem = null;
                setWelcomeMessage();
                return;
            }

            // === THIS IS THE CORRECTED LOGIC BLOCK ===
            if (itemName) { // An item in the list was clicked
                // Check if this is a click on a species, which needs to open another list
                if (majorCat === "„Ç®„Ç≠„Çæ„ÉÅ„ÉÉ„ÇØ„Ç¢„Éã„Éû„É´" && subCat === "ÊïëÊÄ•ÁñæÊÇ£" && !species) {
                    // This is a species click (e.g., "„Ç¶„Çµ„ÇÆ").
                    // The 'itemName' is the species, so we render the item list again for that species.
                    renderItemList(majorCat, subCat, itemName); 
                    setWelcomeMessage();
                } else {
                    // This is a click on a final article.
                    if (activeItem === itemName && activeSubCategory === subCat) return;
                    activeItem = itemName;
                    activeSubCategory = subCat;
                    document.querySelectorAll('#item-list a').forEach(a => a.classList.remove('bg-emerald-100', 'font-semibold'));
                    link.classList.add('bg-emerald-100', 'font-semibold');
                    renderDetail(majorCat, subCat, itemName, species);
                }
            } else { // A sub-category was clicked
                if (activeSubCategory === subCat) return;
                activeSubCategory = subCat;
                activeItem = null;
                // Whether it's the special exotic case or a regular one, we render the next item list.
                // The logic inside renderItemList will correctly show species or articles.
                renderItemList(majorCat, subCat);
                setWelcomeMessage();
            }
        });

        // --- Initialization ---
        async function init() {
            renderNavigation();
            setWelcomeMessage();
            contentData = await fetchMicroCMSData();
            
            // Auto-select the first category after data is loaded
            const firstCategoryLink = navList.querySelector('a');
            if (firstCategoryLink) {
                firstCategoryLink.click();
            }
        }

        // --- Calculator Rendering & Logic ---
        function renderCalculator(title, id) {
             let html = `<h2 class="text-3xl font-bold text-gray-800 mb-6">${title}</h2>`;
            html += `<div id="calc-${id}" class="space-y-4">`;
            
            switch(id) {
                case 'calorie_dogcat':
                    html += `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="cal-weight" class="block text-sm font-medium text-gray-700">‰ΩìÈáç (kg)</label><input type="number" id="cal-weight" class="mt-1 calc-input" placeholder="‰æã: 5"></div>
                            <div><label for="cal-factor" class="block text-sm font-medium text-gray-700">Áä∂ÊÖã</label><select id="cal-factor" class="mt-1 calc-input">
                                <optgroup label="Áä¨"><option value="1.6">ÈÅøÂ¶ä„ÉªÂéªÂã¢Ê∏à ÊàêÁä¨</option><option value="1.8">Êú™ÈÅøÂ¶ä„ÉªÊú™ÂéªÂã¢ ÊàêÁä¨</option><option value="1.4">ËÇ•Ê∫ÄÂÇæÂêë</option><option value="1.0">Ê∏õÈáè‰∏≠</option><option value="1.2">ÈáçÁóá</option><option value="3.0">ÊàêÈï∑Êúü („Äú4„É∂Êúà)</option><option value="2.0">ÊàêÈï∑Êúü (4„É∂Êúà„Äú)</option><option value="1.8">Â¶äÂ®†ÂâçÊúü</option><option value="3.0">Â¶äÂ®†ÂæåÊúü</option><option value="4">Êéà‰π≥Êúü(1-2Â≠ê)</option><option value="5">Êéà‰π≥Êúü(3-4Â≠ê)</option><option value="6">Êéà‰π≥Êúü(5Â≠ê‰ª•‰∏ä)</option></optgroup>
                                <optgroup label="Áå´"><option value="1.2">ÈÅøÂ¶ä„ÉªÂéªÂã¢Ê∏à ÊàêÁå´</option><option value="1.4">Êú™ÈÅøÂ¶ä„ÉªÊú™ÂéªÂã¢ ÊàêÁå´</option><option value="1.0">ËÇ•Ê∫ÄÂÇæÂêë</option><option value="0.8">Ê∏õÈáè‰∏≠</option><option value="1.2">ÈáçÁóá</option><option value="2.5">ÊàêÈï∑Êúü</option><option value="2.0">Â¶äÂ®†Êúü</option><option value="2.5">Êéà‰π≥Êúü</option></optgroup>
                            </select></div>
                            <div><label for="cal-food-density" class="block text-sm font-medium text-gray-700">„Éï„Éº„Éâ„ÅÆ„Ç´„É≠„É™„Éº (kcal/100g)</label><input type="number" id="cal-food-density" class="mt-1 calc-input" placeholder="‰æã: 380"></div>
                        </div>`;
                    break;
                case 'bsa':
                     html += `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="bsa-species" class="block text-sm font-medium text-gray-700">ÂãïÁâ©Á®Æ</label><select id="bsa-species" class="mt-1 calc-input"><option value="dog">Áä¨</option><option value="cat">Áå´</option></select></div>
                            <div><label for="bsa-weight" class="block text-sm font-medium text-gray-700">‰ΩìÈáç (kg)</label><input type="number" id="bsa-weight" class="mt-1 calc-input" placeholder="‰æã: 10"></div>
                        </div>`;
                    break;
                case 'transfusion':
                    html += `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div><label for="tf-species" class="block text-sm font-medium text-gray-700">ÂãïÁâ©Á®Æ</label><select id="tf-species" class="mt-1 calc-input"><option value="dog">Áä¨</option><option value="cat">Áå´</option></select></div>
                            <div><label for="tf-weight" class="block text-sm font-medium text-gray-700">ÊÇ£ËÄÖ„ÅÆ‰ΩìÈáç (kg)</label><input type="number" id="tf-weight" class="mt-1 calc-input" placeholder="‰æã: 5"></div>
                            <div><label for="tf-patient-pcv" class="block text-sm font-medium text-gray-700">ÊÇ£ËÄÖ„ÅÆPCV (%)</label><input type="number" id="tf-patient-pcv" class="mt-1 calc-input" placeholder="‰æã: 15"></div>
                            <div><label for="tf-target-pcv" class="block text-sm font-medium text-gray-700">ÁõÆÊ®ôPCV (%)</label><input type="number" id="tf-target-pcv" class="mt-1 calc-input" placeholder="‰æã: 25"></div>
                             <div><label for="tf-donor-pcv" class="block text-sm font-medium text-gray-700">‰æõË°ÄÂãïÁâ©„ÅÆPCV (%)</label><input type="number" id="tf-donor-pcv" class="mt-1 calc-input" placeholder="‰æã: 45"></div>
                        </div>`;
                    break;
                case 'cri_gamma':
                     html += `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="cri-g-conc" class="block text-sm font-medium text-gray-700">Ëñ¨Ââ§ÊøÉÂ∫¶ (mg/mL)</label><input type="number" id="cri-g-conc" class="mt-1 calc-input" placeholder="‰æã: 20"></div>
                            <div><label for="cri-g-weight" class="block text-sm font-medium text-gray-700">‰ΩìÈáç (kg)</label><input type="number" id="cri-g-weight" class="mt-1 calc-input" placeholder="‰æã: 5"></div>
                            <div><label for="cri-g-rate" class="block text-sm font-medium text-gray-700">ÁÇπÊª¥ÊµÅÈáè (mL/hr)</label><input type="number" id="cri-g-rate" class="mt-1 calc-input" placeholder="‰æã: 10"></div>
                            <div><label for="cri-g-total-vol" class="block text-sm font-medium text-gray-700">Ëº∏Ê∂≤ÂÖ®‰ΩìÈáè (mL)</label><input type="number" id="cri-g-total-vol" class="mt-1 calc-input" placeholder="‰æã: 250"></div>
                            <div><label for="cri-g-dose" class="block text-sm font-medium text-gray-700">Êäï‰∏éÈáè (Œºg/kg/min)</label><input type="number" id="cri-g-dose" class="mt-1 calc-input" placeholder="‰æã: 5"></div>
                        </div>`;
                    break;
                case 'medication_exotic_oral':
                    html += `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="med-exo-weight" class="block text-sm font-medium text-gray-700">‰ΩìÈáç (g)</label><input type="number" id="med-exo-weight" class="mt-1 calc-input" placeholder="‰æã: 800"></div>
                            <div><label for="med-exo-dose" class="block text-sm font-medium text-gray-700">Êäï‰∏éÈáè (mg/kg)</label><input type="number" id="med-exo-dose" class="mt-1 calc-input" placeholder="‰æã: 5"></div>
                            <div><label for="med-exo-strength" class="block text-sm font-medium text-gray-700">Ëñ¨Ââ§„ÅÆÂê´ÊúâÈáè (mg/Èå†)</label><input type="number" id="med-exo-strength" class="mt-1 calc-input" placeholder="‰æã: 100"></div>
                            <div><label for="med-exo-drops" class="block text-sm font-medium text-gray-700">1Âõû„ÅÇ„Åü„Çä„ÅÆÁõÆÊ®ôÊäï‰∏éÊª¥‰∏ãÊï∞</label><input type="number" id="med-exo-drops" class="mt-1 calc-input" placeholder="‰æã: 2"></div>
                        </div>`;
                    break;
                case 'medication_exotic_water':
                    html += `
                        <div>
                            <div class="border-b border-gray-200"><nav class="-mb-px flex space-x-8" id="water-med-tabs"><a href="#" class="border-emerald-500 text-emerald-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="from_dose">Êäï‰∏éÈáè„Åã„ÇâË®àÁÆó</a><a href="#" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="from_conc">ÁõÆÊ®ôÊøÉÂ∫¶„Åã„ÇâË®àÁÆó</a></nav></div>
                            <div id="tab-content-from_dose" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label for="wm-fd-weight" class="block text-sm font-medium text-gray-700">‰ΩìÈáç (g)</label><input type="number" id="wm-fd-weight" class="mt-1 calc-input" placeholder="‰æã: 40"></div>
                                <div><label for="wm-fd-dose" class="block text-sm font-medium text-gray-700">Êäï‰∏éÈáè (mg/kg/Êó•)</label><input type="number" id="wm-fd-dose" class="mt-1 calc-input" placeholder="‰æã: 1"></div>
                                <div><label for="wm-fd-intake" class="block text-sm font-medium text-gray-700">1Êó•„ÅÆÈ£≤Ê∞¥Èáè (mL)</label><input type="number" id="wm-fd-intake" class="mt-1 calc-input" placeholder="‰æã: 4"></div>
                                <div><label for="wm-fd-strength" class="block text-sm font-medium text-gray-700">Ëñ¨Ââ§„ÅÆÂê´ÊúâÈáè (mg/Èå† or g)</label><input type="number" id="wm-fd-strength" class="mt-1 calc-input" placeholder="‰æã: 10"></div>
                                <div><label for="wm-fd-volume" class="block text-sm font-medium text-gray-700">1ÂåÖ„ÇíÊ∫∂Ëß£„Åô„ÇãÊ∞¥„ÅÆÈáè (mL)</label><input type="number" id="wm-fd-volume" class="mt-1 calc-input" placeholder="‰æã: 25"></div>
                                <div><label for="wm-fd-days" class="block text-sm font-medium text-gray-700">Êäï‰∏éÊó•Êï∞ (Êó•)</label><input type="number" id="wm-fd-days" class="mt-1 calc-input" placeholder="‰æã: 10"></div>
                            </div>
                            <div id="tab-content-from_conc" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                                <div><label for="wm-fc-conc" class="block text-sm font-medium text-gray-700">ÁõÆÊ®ôÊøÉÂ∫¶ (mg/L)</label><input type="number" id="wm-fc-conc" class="mt-1 calc-input" placeholder="‰æã: 10"></div>
                                <div><label for="wm-fc-strength" class="block text-sm font-medium text-gray-700">Ëñ¨Ââ§„ÅÆÂê´ÊúâÈáè (mg/Èå† or g)</label><input type="number" id="wm-fc-strength" class="mt-1 calc-input" placeholder="‰æã: 10"></div>
                                <div><label for="wm-fc-volume" class="block text-sm font-medium text-gray-700">1ÂåÖ„ÇíÊ∫∂Ëß£„Åô„ÇãÊ∞¥„ÅÆÈáè (mL)</label><input type="number" id="wm-fc-volume" class="mt-1 calc-input" placeholder="‰æã: 25"></div>
                                <div><label for="wm-fc-days" class="block text-sm font-medium text-gray-700">Êäï‰∏éÊó•Êï∞ (Êó•)</label><input type="number" id="wm-fc-days" class="mt-1 calc-input" placeholder="‰æã: 10"></div>
                            </div>
                        </div>`;
                    break;
            }
            
            html += `<div id="calc-result-${id}" class="calc-result-box hidden"></div></div>`;
            detailContent.innerHTML = html;
            
            document.getElementById(`calc-${id}`)?.addEventListener('input', () => calculate(id));
            if (id === 'medication_exotic_water') {
                document.getElementById('water-med-tabs').addEventListener('click', (e) => {
                    e.preventDefault();
                    const tab = e.target.closest('a');
                    if (!tab) return;
                    document.querySelectorAll('#water-med-tabs a').forEach(t => t.classList.remove('border-emerald-500', 'text-emerald-600'));
                    tab.classList.add('border-emerald-500', 'text-emerald-600');
                    document.getElementById('tab-content-from_dose').classList.toggle('hidden', tab.dataset.tab !== 'from_dose');
                    document.getElementById('tab-content-from_conc').classList.toggle('hidden', tab.dataset.tab !== 'from_conc');
                    calculate(id);
                });
            }
        }

        function calculate(id) {
            const resultBox = document.getElementById(`calc-result-${id}`);
            let inputs = {};
            let resultHtml = '';
            
            try {
                 switch(id) {
                    case 'calorie_dogcat':
                        inputs = {
                            w: parseFloat(document.getElementById('cal-weight').value),
                            f: parseFloat(document.getElementById('cal-factor').value),
                            d: parseFloat(document.getElementById('cal-food-density').value)
                        };
                        if (Object.values(inputs).some(isNaN) || inputs.w <= 0 || inputs.d <= 0) throw new Error();
                        
                        const rer = 70 * Math.pow(inputs.w, 0.75);
                        const der = rer * inputs.f;
                        const foodAmount = (der / inputs.d) * 100;

                        resultHtml = `
                            <h4 class="font-semibold text-lg mb-2">Ë®àÁÆóÁµêÊûú</h4>
                            <p><strong>ÂÆâÈùôÊôÇ„Ç®„Éç„É´„ÇÆ„ÉºË¶ÅÊ±ÇÈáè (RER):</strong> ${rer.toFixed(1)} kcal/Êó•</p>
                            <p><strong>1Êó•„ÅÇ„Åü„Çä„ÅÆ„Ç®„Éç„É´„ÇÆ„ÉºË¶ÅÊ±ÇÈáè (DER):</strong> ${der.toFixed(1)} kcal/Êó•</p>
                            <p class="text-xl font-bold mt-2 text-emerald-700"><strong>1Êó•„ÅÆÁµ¶‰∏éÈáè:</strong> ${foodAmount.toFixed(1)} g/Êó•</p>
                            <h5 class="font-semibold mt-4 mb-1">Ë®àÁÆóÈÅéÁ®ã</h5>
                            <div class="calc-formula">
RER (kcal/Êó•) = 70 * (‰ΩìÈáç(kg) ^ 0.75)
  = 70 * (${inputs.w} ^ 0.75) = ${rer.toFixed(1)}

DER (kcal/Êó•) = RER * Ê¥ªÂãï‰øÇÊï∞
  = ${rer.toFixed(1)} * ${inputs.f} = ${der.toFixed(1)}
 
Áµ¶‰∏éÈáè (g/Êó•) = DER / („Éï„Éº„Éâkcal / 100g) * 100
  = ${der.toFixed(1)} / ${inputs.d} * 100 = ${foodAmount.toFixed(1)}
                            </div>`;
                        break;
                    case 'medication_exotic_oral':
                        inputs = {
                            w: parseFloat(document.getElementById('med-exo-weight').value) / 1000, // g to kg
                            dose: parseFloat(document.getElementById('med-exo-dose').value),
                            strength: parseFloat(document.getElementById('med-exo-strength').value),
                            drops: parseFloat(document.getElementById('med-exo-drops').value)
                        };
                        if (Object.values(inputs).some(isNaN) || inputs.w <= 0 || inputs.strength <= 0 || inputs.drops <= 0) throw new Error();

                        const requiredDoseMg = inputs.w * inputs.dose;
                        const doseVolumeMl = inputs.drops * 0.05;
                        const requiredConc = requiredDoseMg / doseVolumeMl;
                        const waterVolume = inputs.strength / requiredConc;

                        resultHtml = `
                            <h4 class="font-semibold text-lg mb-2">Ë®àÁÆóÁµêÊûú</h4>
                            <p><strong>1Âõû„Å´ÂøÖË¶Å„Å™Ëñ¨Ââ§Èáè:</strong> ${requiredDoseMg.toFixed(3)} mg</p>
                            <p><strong>ÁõÆÊ®ô„Å®„Åô„ÇãÊäï‰∏éÊ∂≤Èáè:</strong> ${doseVolumeMl.toFixed(3)} mL (${inputs.drops} Êª¥)</p>
                            <p><strong>ÂøÖË¶Å„Å™Ëñ¨Ê∂≤ÊøÉÂ∫¶:</strong> ${requiredConc.toFixed(2)} mg/mL</p>
                            <p class="text-xl font-bold mt-2 text-emerald-700"><strong>${inputs.strength}mg„ÅÆËñ¨Ââ§1Èå†</strong>„Çí <strong>${waterVolume.toFixed(2)} mL</strong> „ÅÆÊ∞¥„Å´Ê∫∂Ëß£„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                            <h5 class="font-semibold mt-4 mb-1">Ë®àÁÆóÈÅéÁ®ã</h5>
                            <div class="calc-formula">
1Âõû„Å´ÂøÖË¶Å„Å™Ëñ¨Ââ§Èáè(mg) = ‰ΩìÈáç(kg) * Êäï‰∏éÈáè(mg/kg)
  = ${inputs.w.toFixed(3)} * ${inputs.dose} = ${requiredDoseMg.toFixed(3)}

ÁõÆÊ®ôÊäï‰∏éÊ∂≤Èáè(mL) = ÁõÆÊ®ôÊª¥‰∏ãÊï∞ * 0.05
  = ${inputs.drops} * 0.05 = ${doseVolumeMl.toFixed(3)}

ÂøÖË¶Å„Å™Ëñ¨Ê∂≤ÊøÉÂ∫¶(mg/mL) = ÂøÖË¶Å„Å™Ëñ¨Ââ§Èáè(mg) / ÁõÆÊ®ôÊäï‰∏éÊ∂≤Èáè(mL)
  = ${requiredDoseMg.toFixed(3)} / ${doseVolumeMl.toFixed(3)} = ${requiredConc.toFixed(2)}

Ê∫∂Ëß£„Å´ÂøÖË¶Å„Å™Ê∞¥„ÅÆÈáè(mL) = Ëñ¨Ââ§„ÅÆÂê´ÊúâÈáè(mg) / ÂøÖË¶Å„Å™Ëñ¨Ê∂≤ÊøÉÂ∫¶(mg/mL)
  = ${inputs.strength} / ${requiredConc.toFixed(2)} = ${waterVolume.toFixed(2)}
                            </div>`;
                        break;
                    case 'medication_exotic_water':
                        const activeTab = document.querySelector('#water-med-tabs a.border-emerald-500').dataset.tab;
                        if (activeTab === 'from_dose') {
                            inputs = {
                                w: parseFloat(document.getElementById('wm-fd-weight').value) / 1000, // g to kg
                                dose: parseFloat(document.getElementById('wm-fd-dose').value),
                                intake: parseFloat(document.getElementById('wm-fd-intake').value) / 1000, // mL to L
                                strength: parseFloat(document.getElementById('wm-fd-strength').value),
                                volume: parseFloat(document.getElementById('wm-fd-volume').value) / 1000, // mL to L
                                days: parseInt(document.getElementById('wm-fd-days').value)
                            };
                            if (Object.values(inputs).some(isNaN) || inputs.w <= 0 || inputs.intake <= 0 || inputs.strength <= 0 || inputs.volume <= 0 || inputs.days <= 0) throw new Error();

                            const dailyDoseMg = inputs.w * inputs.dose;
                            const targetConc = dailyDoseMg / inputs.intake;
                            const drugPerBottle = targetConc * inputs.volume;
                            const totalDrug = drugPerBottle * inputs.days;
                            const totalTablets = totalDrug / inputs.strength;

                            resultHtml = `
                                <h4 class="font-semibold text-lg mb-2">Ë®àÁÆóÁµêÊûú</h4>
                                <p><strong>ÁõÆÊ®ôÊøÉÂ∫¶:</strong> ${targetConc.toFixed(2)} mg/L</p>
                                <p class="text-xl font-bold mt-2 text-emerald-700">Ëñ¨Ââ§ <strong>${totalTablets.toFixed(2)} Èå†(or g)</strong> „Çí <strong>${inputs.days}ÂåÖ</strong> „Å´ÂàÜ„Åë„ÄÅ<br>1ÂåÖ„Çí1Êó•1Âõû„ÄÅÈ£≤Ê∞¥ ${inputs.volume * 1000} mL„Å´Ê∑∑„Åú„Å¶Êäï‰∏é„Åó„Åæ„Åô„ÄÇ</p>
                                <h5 class="font-semibold mt-4 mb-1">Ë®àÁÆóÈÅéÁ®ã</h5>
                                <div class="calc-formula">
1Êó•„ÅÆÂøÖË¶ÅËñ¨Ââ§Èáè(mg) = ‰ΩìÈáç(kg) * Êäï‰∏éÈáè(mg/kg/Êó•) = ${dailyDoseMg.toFixed(3)}
ÁõÆÊ®ôÊøÉÂ∫¶(mg/L) = 1Êó•„ÅÆÂøÖË¶ÅËñ¨Ââ§Èáè(mg) / 1Êó•„ÅÆÈ£≤Ê∞¥Èáè(L) = ${targetConc.toFixed(2)}
1ÂåÖ„ÅÇ„Åü„Çä„ÅÆËñ¨Ââ§Èáè(mg) = ÁõÆÊ®ôÊøÉÂ∫¶(mg/L) * Ê∫∂Ëß£„Åô„ÇãÊ∞¥„ÅÆÈáè(L) = ${drugPerBottle.toFixed(3)}
Á∑èËñ¨Ââ§Èáè(mg) = 1ÂåÖ„ÅÇ„Åü„Çä„ÅÆËñ¨Ââ§Èáè(mg) * Êäï‰∏éÊó•Êï∞ = ${totalDrug.toFixed(3)}
Á∑èÈå†Ââ§Êï∞(Èå†) = Á∑èËñ¨Ââ§Èáè(mg) / Ëñ¨Ââ§„ÅÆÂê´ÊúâÈáè(mg) = ${totalTablets.toFixed(2)}
                                </div>`;

                        } else { // from_conc
                            inputs = {
                                conc: parseFloat(document.getElementById('wm-fc-conc').value),
                                strength: parseFloat(document.getElementById('wm-fc-strength').value),
                                volume: parseFloat(document.getElementById('wm-fc-volume').value) / 1000, // mL to L
                                days: parseInt(document.getElementById('wm-fc-days').value)
                            };
                             if (Object.values(inputs).some(isNaN) || inputs.conc <= 0 || inputs.strength <= 0 || inputs.volume <= 0 || inputs.days <= 0) throw new Error();
                            
                            const drugPerBottle_fc = inputs.conc * inputs.volume;
                            const totalDrug_fc = drugPerBottle_fc * inputs.days;
                            const totalTablets_fc = totalDrug_fc / inputs.strength;

                             resultHtml = `
                                <h4 class="font-semibold text-lg mb-2">Ë®àÁÆóÁµêÊûú</h4>
                                <p class="text-xl font-bold mt-2 text-emerald-700">Ëñ¨Ââ§ <strong>${totalTablets_fc.toFixed(2)} Èå†(or g)</strong> „Çí <strong>${inputs.days}ÂåÖ</strong> „Å´ÂàÜ„Åë„ÄÅ<br>1ÂåÖ„Çí1Êó•1Âõû„ÄÅÈ£≤Ê∞¥ ${inputs.volume * 1000} mL„Å´Ê∑∑„Åú„Å¶Êäï‰∏é„Åó„Åæ„Åô„ÄÇ</p>
                                <h5 class="font-semibold mt-4 mb-1">Ë®àÁÆóÈÅéÁ®ã</h5>
                                <div class="calc-formula">
1ÂåÖ„ÅÇ„Åü„Çä„ÅÆËñ¨Ââ§Èáè(mg) = ÁõÆÊ®ôÊøÉÂ∫¶(mg/L) * Ê∫∂Ëß£„Åô„ÇãÊ∞¥„ÅÆÈáè(L) = ${drugPerBottle_fc.toFixed(3)}
Á∑èËñ¨Ââ§Èáè(mg) = 1ÂåÖ„ÅÇ„Åü„Çä„ÅÆËñ¨Ââ§Èáè(mg) * Êäï‰∏éÊó•Êï∞ = ${totalDrug_fc.toFixed(3)}
Á∑èÈå†Ââ§Êï∞(Èå†) = Á∑èËñ¨Ââ§Èáè(mg) / Ëñ¨Ââ§„ÅÆÂê´ÊúâÈáè(mg) = ${totalTablets_fc.toFixed(2)}
                                </div>`;
                        }
                        break;
                    
                    case 'bsa':
                        inputs = {
                            w: parseFloat(document.getElementById('bsa-weight').value),
                            s: document.getElementById('bsa-species').value
                        };
                        if (isNaN(inputs.w) || inputs.w <= 0) throw new Error();
                        const k = inputs.s === 'dog' ? 10.1 : 10.0;
                        const bsa = k * Math.pow(inputs.w * 1000, 2/3) / 10000;

                        resultHtml = `
                            <h4 class="font-semibold text-lg mb-2">Ë®àÁÆóÁµêÊûú</h4>
                            <p class="text-xl font-bold mt-2 text-emerald-700"><strong>‰ΩìË°®Èù¢Á©ç (BSA):</strong> ${bsa.toFixed(4)} m¬≤</p>
                            <h5 class="font-semibold mt-4 mb-1">Ë®àÁÆóÈÅéÁ®ã</h5>
                            <div class="calc-formula">
BSA (m¬≤) = (K * (‰ΩìÈáç(g) ^ (2/3))) / 10000
  = (${k} * ((${inputs.w}*1000) ^ (2/3))) / 10000 = ${bsa.toFixed(4)}
                            </div>
                            <div class="mt-6">
                                <h4 class="font-semibold text-lg mb-2">BSAÊó©Ë¶ãË°®</h4>
                                <div class="table-container">
                                    <table class="custom-table text-sm">
                                        <thead><tr><th>‰ΩìÈáç(kg)</th><th>BSA(m¬≤)</th><th>‰ΩìÈáç(kg)</th><th>BSA(m¬≤)</th><th>‰ΩìÈáç(kg)</th><th>BSA(m¬≤)</th></tr></thead>
                                        <tbody id="bsa-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                            `;
                        break;

                    case 'transfusion':
                        inputs = {
                            s: document.getElementById('tf-species').value,
                            w: parseFloat(document.getElementById('tf-weight').value),
                            pPCV: parseFloat(document.getElementById('tf-patient-pcv').value),
                            tPCV: parseFloat(document.getElementById('tf-target-pcv').value),
                            dPCV: parseFloat(document.getElementById('tf-donor-pcv').value)
                        };
                        if (Object.values(inputs).slice(1).some(isNaN)) throw new Error();
                        const bloodVolConstant = inputs.s === 'dog' ? 90 : 70;
                        const requiredBlood = (inputs.w * bloodVolConstant * (inputs.tPCV - inputs.pPCV)) / inputs.dPCV;

                        resultHtml = `
                            <h4 class="font-semibold text-lg mb-2">Ë®àÁÆóÁµêÊûú</h4>
                            <p class="text-xl font-bold mt-2 text-emerald-700"><strong>ÂøÖË¶ÅË°ÄÊ∂≤Èáè:</strong> ${requiredBlood.toFixed(1)} mL</p>
                            <h5 class="font-semibold mt-4 mb-1">Ë®àÁÆóÈÅéÁ®ã</h5>
                            <div class="calc-formula">
ÂøÖË¶ÅË°ÄÊ∂≤Èáè(mL) = (‰ΩìÈáç(kg) * Ë°ÄÊ∂≤Èáè‰øÇÊï∞ * (ÁõÆÊ®ôPCV - ÊÇ£ËÄÖPCV)) / ‰æõË°ÄÂãïÁâ©PCV
  = (${inputs.w} * ${bloodVolConstant} * (${inputs.tPCV} - ${inputs.pPCV})) / ${inputs.dPCV} = ${requiredBlood.toFixed(1)}
                            </div>`;
                        break;

                    case 'cri_gamma':
                        inputs = {
                            conc: parseFloat(document.getElementById('cri-g-conc').value),
                            w: parseFloat(document.getElementById('cri-g-weight').value),
                            rate: parseFloat(document.getElementById('cri-g-rate').value),
                            vol: parseFloat(document.getElementById('cri-g-total-vol').value),
                            dose: parseFloat(document.getElementById('cri-g-dose').value)
                        };
                        if (Object.values(inputs).some(isNaN)) throw new Error();
                        const drugAmountMl = (inputs.dose * inputs.w * inputs.vol * 60) / (inputs.conc * 1000 * inputs.rate);

                        resultHtml = `
                            <h4 class="font-semibold text-lg mb-2">Ë®àÁÆóÁµêÊûú</h4>
                            <p>Ëº∏Ê∂≤${inputs.vol}mL„Å´Ëñ¨Ââ§„Çí <strong class="text-xl text-emerald-700">${drugAmountMl.toFixed(2)} mL</strong> Ê∑ªÂä†„Åó„ÄÅ<br><strong>${inputs.rate} mL/hr</strong> „ÅÆÊµÅÈáè„ÅßÊäï‰∏é„Åó„Åæ„Åô„ÄÇ</p>
                            <h5 class="font-semibold mt-4 mb-1">Ë®àÁÆóÈÅéÁ®ã</h5>
                            <div class="calc-formula">
Ëñ¨Ââ§Èáè(mL) = (Êäï‰∏éÈáè(Œºg/kg/min) * ‰ΩìÈáç(kg) * ÂÖ®‰ΩìÈáè(mL) * 60) / (Ëñ¨Ââ§ÊøÉÂ∫¶(mg/mL) * 1000 * ÁÇπÊª¥ÊµÅÈáè(mL/hr))
  = (${inputs.dose} * ${inputs.w} * ${inputs.vol} * 60) / (${inputs.conc} * 1000 * ${inputs.rate}) = ${drugAmountMl.toFixed(2)}
                            </div>`;
                        break;
                }
                resultBox.innerHTML = resultHtml;
                resultBox.classList.remove('hidden');

                if (id === 'bsa') {
                    generateBsaTable(inputs.s);
                }

            } catch (e) {
                resultBox.classList.add('hidden');
            }
        }

        function generateBsaTable(species) {
            const tableBody = document.getElementById('bsa-table-body');
            if (!tableBody) return;
            const k = species === 'dog' ? 10.1 : 10.0;
            const weights = [1,2,3,4,5,6,7,8,9,10,12,14,16,18,20,25,30,35,40,45,50,55,60];
            let tableHtml = '';
            for(let i = 0; i < weights.length; i += 3) {
                tableHtml += '<tr>';
                for(let j = 0; j < 3; j++) {
                    const weight = weights[i+j];
                    if(weight) {
                        const bsa = k * Math.pow(weight * 1000, 2/3) / 10000;
                        tableHtml += `<td><strong>${weight}kg</strong></td><td>${bsa.toFixed(3)} m¬≤</td>`;
                    } else {
                        tableHtml += '<td></td><td></td>';
                    }
                }
                tableHtml += '</tr>';
            }
            tableBody.innerHTML = tableHtml;
        }

        init();

    </script>
</body>
</html>
