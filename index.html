<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>獣医療 救急疾患＆計算ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .content-section h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            margin-top: 1.75rem; /* mt-7 */
            margin-bottom: 0.75rem; /* mb-3 */
            padding-bottom: 0.5rem; /* pb-2 */
            border-bottom: 2px solid #34d399; /* border-b-2 border-emerald-400 */
            color: #047857; /* text-emerald-700 */
        }
        .content-section ul { list-style-type: disc; padding-left: 1.75rem; margin-top: 0.5rem; }
        .content-section li { margin-bottom: 0.5rem; }
        
        /* Table styles */
        .table-container { overflow-x: auto; margin-top: 1rem; }
        .custom-table { width: 100%; border-collapse: collapse; }
        .custom-table th, .custom-table td { border: 1px solid #d1d5db; padding: 0.75rem; text-align: left; }
        .custom-table th { background-color: #f3f4f6; font-weight: 600; }
        .custom-table tr:nth-child(even) { background-color: #f9fafb; }

        /* Calculator styles */
        .calc-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .calc-input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }
        .calc-result-box {
            background-color: #f0fdfa; /* emerald-50 */
            border: 1px solid #a7f3d0; /* emerald-200 */
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1.5rem;
        }
        .calc-formula {
            background-color: #e5e7eb; /* gray-200 */
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.9rem;
        }
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Hide elements helper */
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex h-screen overflow-hidden">
        <nav id="sidebar" class="w-16 md:w-56 bg-gray-800 text-white flex flex-col transition-all duration-300 flex-shrink-0">
            <div class="px-4 py-5 border-b border-gray-700 flex items-center justify-center md:justify-start">
                <svg class="h-8 w-8 text-emerald-400" xmlns="http://www.w.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-9-5.747h18"/>
                </svg>
                <h1 class="text-xl font-bold ml-3 hidden md:block">Vet Tools</h1>
            </div>
            <ul id="nav-list" class="flex-grow overflow-y-auto">
                </ul>
             <div class="px-4 py-3 border-t border-gray-700">
                <p class="text-xs text-gray-500 text-center hidden md:block">&copy; 2024 Vet Emergency Guide</p>
            </div>
        </nav>

        <main class="flex-1 flex overflow-hidden">
            <div id="list-panel" class="w-full md:w-1/4 lg:w-1/5 bg-white border-r border-gray-200 overflow-y-auto flex-shrink-0">
                 <div class="p-4 border-b border-gray-200 sticky top-0 bg-white z-10">
                    <h2 id="category-title" class="text-xl font-bold text-gray-700">カテゴリを選択</h2>
                </div>
                <ul id="item-list">
                    </ul>
            </div>

            <div id="detail-panel" class="flex-1 overflow-y-auto p-6 md:p-8 lg:p-10">
                <div id="detail-content">
                    </div>
            </div>
        </main>
    </div>

    <script src="calculators.js" defer></script>

    <script>
        // --- microCMS Configuration ---
        const MICROCMS_CONFIG = {
            apiKey: '66U37gIl7UHa9gJqv5OyV3OI6IbBh5Awu7jS', // 実際のAPIキーに置き換えてください
            serviceDomain: 'vetinfo'
        };

        // --- SPA-Managed Data (Calculators) ---
        const calculatorDefinitions = {
            "犬・猫": {
                "計算ツール": {
                    "栄養計算 (RER/DER)": { "type": "calculator", "id": "calorie_dogcat_detailed" },
                    "体表面積 (BSA)": { "type": "calculator", "id": "bsa" },
                    "輸血量計算": { "type": "calculator", "id": "transfusion" },
                    "CRI計算 (μg/kg/min)": { "type": "calculator", "id": "cri_gamma" },
                    "維持輸液量計算": { "type": "calculator", "id": "fluids" },
                    "滴下速度換算": { "type": "calculator", "id": "drip" },
                    "希釈計算": { "type": "calculator", "id": "dilution" },
                    "酸素流量計算": { "type": "calculator", "id": "oxygen" },
                    "電解質補正 (Na/K)": { "type": "calculator", "id": "electrolytes" },
                    "混合浸透圧計算": { "type": "calculator", "id": "osmolarity" },
                    "理想体重と減量計画": { "type": "calculator", "id": "weight_loss_ideal" }
                }
            },
            "エキゾチックアニマル": {
                 "計算ツール": {
                    "経口投薬量計算": { "type": "calculator", "id": "medication_exotic_oral" },
                    "飲水投薬量計算": { "type": "calculator", "id": "medication_exotic_water" }
                }
            }
        };

        // --- Global State ---
        let contentData = {};
        let activeMajorCategory = null;
        let activeSubCategory = null;
        let activeItem = null;

        // --- DOM Elements ---
        const navList = document.getElementById('nav-list');
        const categoryTitle = document.getElementById('category-title');
        const itemList = document.getElementById('item-list');
        const detailContent = document.getElementById('detail-content');

        // --- Data Fetching & Processing ---
        async function fetchMicroCMSData() {
            setLoading(detailContent);
            try {
                const response = await fetch(`https://${MICROCMS_CONFIG.serviceDomain}.microcms.io/api/v1/articles?limit=100&depth=2`, {
                    headers: { 'X-MICROCMS-API-KEY': MICROCMS_CONFIG.apiKey }
                });
                if (!response.ok) throw new Error(`API fetch failed: ${response.status}`);
                const data = await response.json();
                return processFetchedData(data.contents);
            } catch (error) {
                console.error("Failed to fetch from microCMS:", error);
                setError(detailContent, "コンテンツの読み込みに失敗しました。APIキーとサービスドメインを確認してください。");
                return {};
            }
        }

        function processFetchedData(articles) {
            const processedData = {};
            articles.forEach(article => {
                const majorCat = article.animal_group?.group_name;
                const subCat = article.content_category?.category_name;
                if (!majorCat || !subCat) return;

                if (!processedData[majorCat]) processedData[majorCat] = {};
                if (!processedData[majorCat][subCat]) processedData[majorCat][subCat] = {};
                
                if (majorCat === "エキゾチックアニマル" && subCat === "救急疾患" && article.exotic_species) {
                    const species = article.exotic_species.species_name;
                    if (!processedData[majorCat][subCat][species]) {
                        processedData[majorCat][subCat][species] = {};
                    }
                    processedData[majorCat][subCat][species][article.title] = article;
                } else {
                    processedData[majorCat][subCat][article.title] = article;
                }
            });
            return processedData;
        }

        // --- Rendering Functions ---
        function renderNavigation() {
            navList.innerHTML = '';
            const majorCategories = { "犬・猫": "", "エキゾチックアニマル": "" };
            
            Object.keys(majorCategories).forEach(cat => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <a href="#" class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors duration-200" data-major-category="${cat}">
                        <span class="w-8 text-center text-lg">${majorCategories[cat]}</span>
                        <span class="ml-3 hidden md:inline">${cat}</span>
                    </a>
                `;
                navList.appendChild(li);
            });
        }

        function renderSubCategoryList(majorCat) {
            categoryTitle.textContent = majorCat;
            const contentSubCats = contentData[majorCat] ? Object.keys(contentData[majorCat]) : [];
            const calcSubCats = calculatorDefinitions[majorCat] ? Object.keys(calculatorDefinitions[majorCat]) : [];
            const allSubCats = [...new Set([...contentSubCats, ...calcSubCats])];

            itemList.innerHTML = allSubCats.map(subCat => `
                <li>
                    <a href="#" class="block px-4 py-3 text-gray-700 hover:bg-emerald-50 border-b border-gray-100" data-major-category="${majorCat}" data-sub-category="${subCat}">
                        ${subCat}
                    </a>
                </li>
            `).join('');
        }

        function renderItemList(majorCat, subCat, species = null) {
            let path = `${majorCat} > ${subCat}`;
            if (species) {
                path += ` > ${species}`;
            }
            categoryTitle.textContent = path;

            const isCalc = calculatorDefinitions[majorCat] && calculatorDefinitions[majorCat][subCat];
            let dataRoot = isCalc ? calculatorDefinitions[majorCat][subCat] : contentData[majorCat][subCat];
            if (species) {
                dataRoot = dataRoot[species];
            }
            const items = Object.keys(dataRoot || {});

            let listHtml = `<li><a href="#" class="block px-4 py-3 font-bold text-emerald-600 hover:bg-emerald-50 border-b border-gray-100" data-major-category="${majorCat}" data-sub-category="BACK" data-species="${species || ''}">← 戻る</a></li>`;
            
            listHtml += items.map(item => `
                <li>
                    <a href="#" class="block px-4 py-3 text-gray-700 hover:bg-emerald-50 border-b border-gray-100" data-major-category="${majorCat}" data-sub-category="${subCat}" data-item="${item}" data-species="${species || ''}">
                        ${item}
                    </a>
                </li>
            `).join('');
            itemList.innerHTML = listHtml;
        }
        
        function renderDetail(majorCat, subCat, itemName, species = null) {
            const isCalc = calculatorDefinitions[majorCat] && calculatorDefinitions[majorCat][subCat];
            let data;
            let titlePath = `${majorCat} > ${subCat}`;

            if (isCalc) {
                data = calculatorDefinitions[majorCat][subCat][itemName];
            } else {
                data = species ? contentData[majorCat][subCat][species][itemName] : contentData[majorCat][subCat][itemName];
                if (species) {
                    titlePath += ` > ${species}`;
                }
            }
            
            if (!data) {
                setError(detailContent, "コンテンツの読み込みに失敗しました。");
                return;
            }

            if (data.type === 'calculator') {
                renderCalculator(itemName, data.id);
                return;
            }

            let contentHtml = `<h2 class="text-3xl font-bold text-gray-800 mb-2">${data.title}</h2>`;
            contentHtml += `<p class="text-sm text-gray-500 mb-6">カテゴリ: ${titlePath}</p>`;

            if (data.overview) {
                 contentHtml += `<div class="content-section"><h3>概要</h3><p class="text-gray-700 leading-relaxed">${data.overview}</p></div>`;
            }
            if (data.body) {
                contentHtml += `<div class="content-section"><h3>詳細</h3>${data.body}</div>`;
            }

            detailContent.innerHTML = contentHtml;
        }

        // --- UI State Functions ---
        function setWelcomeMessage() {
            detailContent.innerHTML = `
                <div class="text-center py-20">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" /></svg>
                    <h3 class="mt-2 text-lg font-medium text-gray-900">データを選択してください</h3>
                    <p class="mt-1 text-sm text-gray-500">左のメニューからカテゴリと項目を選択すると、ここに詳細が表示されます。</p>
                </div>`;
        }

        function setLoading(element) {
            element.innerHTML = '<div class="loader"></div>';
        }

        function setError(element, message) {
            element.innerHTML = `<div class="text-center py-20 text-red-600">${message}</div>`;
        }
        
        // --- Event Handlers ---
        navList.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (!link) return;
            e.preventDefault();

            const majorCat = link.dataset.majorCategory;
            if (activeMajorCategory === majorCat) return;

            activeMajorCategory = majorCat;
            activeSubCategory = null;
            activeItem = null;

            document.querySelectorAll('#nav-list a').forEach(a => a.classList.remove('bg-gray-700', 'text-white'));
            link.classList.add('bg-gray-700', 'text-white');

            renderSubCategoryList(majorCat);
            setWelcomeMessage();
        });

        itemList.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (!link) return;
            e.preventDefault();

            const majorCat = link.dataset.majorCategory;
            const subCat = link.dataset.subCategory;
            const itemName = link.dataset.item;
            const species = link.dataset.species;

            if (subCat === 'BACK') {
                if (species) {
                    renderItemList(majorCat, "救急疾患");
                } else {
                    activeSubCategory = null;
                    renderSubCategoryList(majorCat);
                }
                activeItem = null;
                setWelcomeMessage();
                return;
            }

            if (itemName) {
                if (majorCat === "エキゾチックアニマル" && subCat === "救急疾患" && !species) {
                    renderItemList(majorCat, subCat, itemName); 
                    setWelcomeMessage();
                } else {
                    if (activeItem === itemName && activeSubCategory === subCat) return;
                    activeItem = itemName;
                    activeSubCategory = subCat;
                    document.querySelectorAll('#item-list a').forEach(a => a.classList.remove('bg-emerald-100', 'font-semibold'));
                    link.classList.add('bg-emerald-100', 'font-semibold');
                    renderDetail(majorCat, subCat, itemName, species);
                }
            } else {
                if (activeSubCategory === subCat) return;
                activeSubCategory = subCat;
                activeItem = null;
                renderItemList(majorCat, subCat);
                setWelcomeMessage();
            }
        });

        // --- Initialization ---
        async function init() {
            renderNavigation();
            setWelcomeMessage();
            contentData = await fetchMicroCMSData();
            
            const firstCategoryLink = navList.querySelector('a');
            if (firstCategoryLink) {
                firstCategoryLink.click();
            }
        }
        
        init();

    </script>
</body>
</html>
