<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç£åŒ»ç™‚ æ•‘æ€¥ç–¾æ‚£ï¼†è¨ˆç®—ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .content-section h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            margin-top: 1.75rem; /* mt-7 */
            margin-bottom: 0.75rem; /* mb-3 */
            padding-bottom: 0.5rem; /* pb-2 */
            border-bottom: 2px solid #34d399; /* border-b-2 border-emerald-400 */
            color: #047857; /* text-emerald-700 */
        }
        .content-section ul { list-style-type: disc; padding-left: 1.75rem; margin-top: 0.5rem; }
        .content-section li { margin-bottom: 0.5rem; }
        
        /* Table styles */
        .table-container { overflow-x: auto; margin-top: 1rem; }
        .custom-table { width: 100%; border-collapse: collapse; }
        .custom-table th, .custom-table td { border: 1px solid #d1d5db; padding: 0.75rem; text-align: left; }
        .custom-table th { background-color: #f3f4f6; font-weight: 600; }
        .custom-table tr:nth-child(even) { background-color: #f9fafb; }

        /* Calculator styles */
        .calc-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .calc-input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }
        .calc-result-box {
            background-color: #f0fdfa; /* emerald-50 */
            border: 1px solid #a7f3d0; /* emerald-200 */
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1.5rem;
        }
        .calc-formula {
            background-color: #e5e7eb; /* gray-200 */
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.9rem;
        }
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex h-screen overflow-hidden">
        <nav id="sidebar" class="w-16 md:w-56 bg-gray-800 text-white flex flex-col transition-all duration-300 flex-shrink-0">
            <div class="px-4 py-5 border-b border-gray-700 flex items-center justify-center md:justify-start">
                <svg class="h-8 w-8 text-emerald-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-9-5.747h18"/>
                </svg>
                <h1 class="text-xl font-bold ml-3 hidden md:block">Vet Guide</h1>
            </div>
            <ul id="nav-list" class="flex-grow overflow-y-auto">
                </ul>
             <div class="px-4 py-3 border-t border-gray-700">
                <p class="text-xs text-gray-500 text-center hidden md:block">&copy; 2024 Vet Emergency Guide</p>
            </div>
        </nav>

        <main class="flex-1 flex overflow-hidden">
            <div id="list-panel" class="w-full md:w-1/4 lg:w-1/5 bg-white border-r border-gray-200 overflow-y-auto flex-shrink-0">
                 <div class="p-4 border-b border-gray-200 sticky top-0 bg-white z-10">
                    <h2 id="category-title" class="text-xl font-bold text-gray-700">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</h2>
                </div>
                <ul id="item-list">
                    </ul>
            </div>

            <div id="detail-panel" class="flex-1 overflow-y-auto p-6 md:p-8 lg:p-10">
                <div id="detail-content">
                    </div>
            </div>
        </main>
    </div>

    <script>
        // --- microCMS Configuration ---
        const MICROCMS_CONFIG = {
            apiKey: '66U37gIl7UHa9gJqv5OyV3OI6IbBh5Awu7jS',
            serviceDomain: 'vetinfo'
        };

        // --- SPA-Managed Data (Calculators) ---
        const calculatorDefinitions = {
            "çŠ¬ãƒ»çŒ«": {
                "è¨ˆç®—ãƒ„ãƒ¼ãƒ«": {
                    "ã‚«ãƒ­ãƒªãƒ¼è¨ˆç®— (RER/DER)": { "type": "calculator", "id": "calorie_dogcat" },
                    "ä½“è¡¨é¢ç© (BSA)": { "type": "calculator", "id": "bsa" },
                    "è¼¸è¡€é‡è¨ˆç®—": { "type": "calculator", "id": "transfusion" },
                    "CRIè¨ˆç®— (Î¼g/kg/min)": { "type": "calculator", "id": "cri_gamma" },
                    "CRIè¨ˆç®— (mg/kg/hr)": { "type": "calculator", "id": "cri_mg_hr" },
                    "CRIè¨ˆç®— (å¸Œé‡ˆãªã—)": { "type": "calculator", "id": "cri_no_dilution" }
                }
            },
            "ã‚¨ã‚­ã‚¾ãƒãƒƒã‚¯ã‚¢ãƒ‹ãƒãƒ«": {
                 "è¨ˆç®—ãƒ„ãƒ¼ãƒ«": {
                    "çµŒå£æŠ•è–¬é‡è¨ˆç®—": { "type": "calculator", "id": "medication_exotic_oral" },
                    "é£²æ°´æŠ•è–¬é‡è¨ˆç®—": { "type": "calculator", "id": "medication_exotic_water" }
                }
            }
        };

        // --- Global State ---
        let contentData = {}; // This will be populated from microCMS
        let activeMajorCategory = null;
        let activeSubCategory = null;
        let activeItem = null;

        // --- DOM Elements ---
        const navList = document.getElementById('nav-list');
        const categoryTitle = document.getElementById('category-title');
        const itemList = document.getElementById('item-list');
        const detailContent = document.getElementById('detail-content');

        // --- Data Fetching & Processing ---
        async function fetchMicroCMSData() {
            setLoading(detailContent);
            try {
                const response = await fetch(`https://${MICROCMS_CONFIG.serviceDomain}.microcms.io/api/v1/articles?limit=100&depth=2`, {
                    headers: { 'X-MICROCMS-API-KEY': MICROCMS_CONFIG.apiKey }
                });
                if (!response.ok) throw new Error(`API fetch failed: ${response.status}`);
                const data = await response.json();
                return processFetchedData(data.contents);
            } catch (error) {
                console.error("Failed to fetch from microCMS:", error);
                setError(detailContent, "ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                return {};
            }
        }

        function processFetchedData(articles) {
            const processedData = {};
            articles.forEach(article => {
                const majorCat = article.animal_group?.group_name;
                const subCat = article.content_category?.category_name;
                if (!majorCat || !subCat) return;

                if (!processedData[majorCat]) processedData[majorCat] = {};
                if (!processedData[majorCat][subCat]) processedData[majorCat][subCat] = {};
                
                if (majorCat === "ã‚¨ã‚­ã‚¾ãƒãƒƒã‚¯ã‚¢ãƒ‹ãƒãƒ«" && subCat === "æ•‘æ€¥ç–¾æ‚£" && article.exotic_species) {
                    const species = article.exotic_species.species_name;
                    if (!processedData[majorCat][subCat][species]) {
                        processedData[majorCat][subCat][species] = {};
                    }
                    processedData[majorCat][subCat][species][article.title] = article;
                } else {
                    processedData[majorCat][subCat][article.title] = article;
                }
            });
            return processedData;
        }

        // --- Rendering Functions ---
        function renderNavigation() {
            navList.innerHTML = '';
            const majorCategories = { "çŠ¬ãƒ»çŒ«": "ğŸ¾", "ã‚¨ã‚­ã‚¾ãƒãƒƒã‚¯ã‚¢ãƒ‹ãƒãƒ«": "ğŸ‡" };
            
            Object.keys(majorCategories).forEach(cat => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <a href="#" class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors duration-200" data-major-category="${cat}">
                        <span class="w-8 text-center text-lg">${majorCategories[cat]}</span>
                        <span class="ml-3 hidden md:inline">${cat}</span>
                    </a>
                `;
                navList.appendChild(li);
            });
        }

        function renderSubCategoryList(majorCat) {
            categoryTitle.textContent = majorCat;
            const contentSubCats = contentData[majorCat] ? Object.keys(contentData[majorCat]) : [];
            const calcSubCats = calculatorDefinitions[majorCat] ? Object.keys(calculatorDefinitions[majorCat]) : [];
            const allSubCats = [...new Set([...contentSubCats, ...calcSubCats])]; // Use Set to remove duplicates

            itemList.innerHTML = allSubCats.map(subCat => `
                <li>
                    <a href="#" class="block px-4 py-3 text-gray-700 hover:bg-emerald-50 border-b border-gray-100" data-major-category="${majorCat}" data-sub-category="${subCat}">
                        ${subCat}
                    </a>
                </li>
            `).join('');
        }

        function renderItemList(majorCat, subCat, species = null) {
            let path = `${majorCat} > ${subCat}`;
            if (species) {
                path += ` > ${species}`;
            }
            categoryTitle.textContent = path;

            const isCalc = calculatorDefinitions[majorCat] && calculatorDefinitions[majorCat][subCat];
            let dataRoot = isCalc ? calculatorDefinitions[majorCat][subCat] : contentData[majorCat][subCat];
            if (species) {
                dataRoot = dataRoot[species];
            }
            const items = Object.keys(dataRoot);

            let listHtml = `<li><a href="#" class="block px-4 py-3 font-bold text-emerald-600 hover:bg-emerald-50 border-b border-gray-100" data-major-category="${majorCat}" data-sub-category="BACK" data-species="${species || ''}">â† æˆ»ã‚‹</a></li>`;
            
            listHtml += items.map(item => `
                <li>
                    <a href="#" class="block px-4 py-3 text-gray-700 hover:bg-emerald-50 border-b border-gray-100" data-major-category="${majorCat}" data-sub-category="${subCat}" data-item="${item}" data-species="${species || ''}">
                        ${item}
                    </a>
                </li>
            `).join('');
            itemList.innerHTML = listHtml;
        }
        
        function renderDetail(majorCat, subCat, itemName, species = null) {
            const isCalc = calculatorDefinitions[majorCat] && calculatorDefinitions[majorCat][subCat];
            let data;
            let titlePath = `${majorCat} > ${subCat}`;

            if (isCalc) {
                data = calculatorDefinitions[majorCat][subCat][itemName];
            } else {
                data = species ? contentData[majorCat][subCat][species][itemName] : contentData[majorCat][subCat][itemName];
                if (species) {
                    titlePath += ` > ${species}`;
                }
            }
            
            if (data.type === 'calculator') {
                renderCalculator(itemName, data.id);
                return;
            }

            let contentHtml = `<h2 class="text-3xl font-bold text-gray-800 mb-2">${data.title}</h2>`;
            contentHtml += `<p class="text-sm text-gray-500 mb-6">ã‚«ãƒ†ã‚´ãƒª: ${titlePath}</p>`;

            if (data.overview) {
                 contentHtml += `<div class="content-section"><h3>æ¦‚è¦</h3><p class="text-gray-700 leading-relaxed">${data.overview}</p></div>`;
            }
            if (data.body) {
                contentHtml += `<div class="content-section"><h3>è©³ç´°</h3>${data.body}</div>`;
            }

            detailContent.innerHTML = contentHtml;
        }

        // --- UI State Functions ---
        function setWelcomeMessage() {
            detailContent.innerHTML = `
                <div class="text-center py-20">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" /></svg>
                    <h3 class="mt-2 text-lg font-medium text-gray-900">ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
                    <p class="mt-1 text-sm text-gray-500">å·¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã¨é …ç›®ã‚’é¸æŠã™ã‚‹ã¨ã€ã“ã“ã«è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                </div>`;
        }

        function setLoading(element) {
            element.innerHTML = '<div class="loader"></div>';
        }

        function setError(element, message) {
            element.innerHTML = `<div class="text-center py-20 text-red-600">${message}</div>`;
        }
        
        // --- Event Handlers ---
        navList.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (!link) return;
            e.preventDefault();

            const majorCat = link.dataset.majorCategory;
            if (activeMajorCategory === majorCat) return;

            activeMajorCategory = majorCat;
            activeSubCategory = null;
            activeItem = null;

            document.querySelectorAll('#nav-list a').forEach(a => a.classList.remove('bg-gray-700', 'text-white'));
            link.classList.add('bg-gray-700', 'text-white');

            renderSubCategoryList(majorCat);
            setWelcomeMessage();
        });

        itemList.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (!link) return;
            e.preventDefault();

            const majorCat = link.dataset.majorCategory;
            const subCat = link.dataset.subCategory;
            const itemName = link.dataset.item;
            const species = link.dataset.species;

            if (subCat === 'BACK') {
                if (species) { // Came from an article list under a species
                    renderItemList(majorCat, "æ•‘æ€¥ç–¾æ‚£");
                } else { // Came from a subcategory list (or species list)
                    activeSubCategory = null;
                    renderSubCategoryList(majorCat);
                }
                activeItem = null;
                setWelcomeMessage();
                return;
            }

            // === THIS IS THE CORRECTED LOGIC BLOCK ===
            if (itemName) { // An item in the list was clicked
                // Check if this is a click on a species, which needs to open another list
                if (majorCat === "ã‚¨ã‚­ã‚¾ãƒãƒƒã‚¯ã‚¢ãƒ‹ãƒãƒ«" && subCat === "æ•‘æ€¥ç–¾æ‚£" && !species) {
                    // This is a species click (e.g., "ã‚¦ã‚µã‚®").
                    // The 'itemName' is the species, so we render the item list again for that species.
                    renderItemList(majorCat, subCat, itemName); 
                    setWelcomeMessage();
                } else {
                    // This is a click on a final article.
                    if (activeItem === itemName && activeSubCategory === subCat) return;
                    activeItem = itemName;
                    activeSubCategory = subCat;
                    document.querySelectorAll('#item-list a').forEach(a => a.classList.remove('bg-emerald-100', 'font-semibold'));
                    link.classList.add('bg-emerald-100', 'font-semibold');
                    renderDetail(majorCat, subCat, itemName, species);
                }
            } else { // A sub-category was clicked
                if (activeSubCategory === subCat) return;
                activeSubCategory = subCat;
                activeItem = null;
                // Whether it's the special exotic case or a regular one, we render the next item list.
                // The logic inside renderItemList will correctly show species or articles.
                renderItemList(majorCat, subCat);
                setWelcomeMessage();
            }
        });

        // --- Initialization ---
        async function init() {
            renderNavigation();
            setWelcomeMessage();
            contentData = await fetchMicroCMSData();
            
            // Auto-select the first category after data is loaded
            const firstCategoryLink = navList.querySelector('a');
            if (firstCategoryLink) {
                firstCategoryLink.click();
            }
        }

        // --- Calculator Rendering & Logic ---
        function renderCalculator(title, id) {
             let html = `<h2 class="text-3xl font-bold text-gray-800 mb-6">${title}</h2>`;
            html += `<div id="calc-${id}" class="space-y-4">`;
            
            switch(id) {
                case 'calorie_dogcat':
                    html += `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="cal-weight" class="block text-sm font-medium text-gray-700">ä½“é‡ (kg)</label><input type="number" id="cal-weight" class="mt-1 calc-input" placeholder="ä¾‹: 5"></div>
                            <div><label for="cal-factor" class="block text-sm font-medium text-gray-700">çŠ¶æ…‹</label><select id="cal-factor" class="mt-1 calc-input">
                                <optgroup label="çŠ¬"><option value="1.6">é¿å¦Šãƒ»å»å‹¢æ¸ˆ æˆçŠ¬</option><option value="1.8">æœªé¿å¦Šãƒ»æœªå»å‹¢ æˆçŠ¬</option><option value="1.4">è‚¥æº€å‚¾å‘</option><option value="1.0">æ¸›é‡ä¸­</option><option value="1.2">é‡ç—‡</option><option value="3.0">æˆé•·æœŸ (ã€œ4ãƒ¶æœˆ)</option><option value="2.0">æˆé•·æœŸ (4ãƒ¶æœˆã€œ)</option><option value="1.8">å¦Šå¨ å‰æœŸ</option><option value="3.0">å¦Šå¨ å¾ŒæœŸ</option><option value="4">æˆä¹³æœŸ(1-2å­)</option><option value="5">æˆä¹³æœŸ(3-4å­)</option><option value="6">æˆä¹³æœŸ(5å­ä»¥ä¸Š)</option></optgroup>
                                <optgroup label="çŒ«"><option value="1.2">é¿å¦Šãƒ»å»å‹¢æ¸ˆ æˆçŒ«</option><option value="1.4">æœªé¿å¦Šãƒ»æœªå»å‹¢ æˆçŒ«</option><option value="1.0">è‚¥æº€å‚¾å‘</option><option value="0.8">æ¸›é‡ä¸­</option><option value="1.2">é‡ç—‡</option><option value="2.5">æˆé•·æœŸ</option><option value="2.0">å¦Šå¨ æœŸ</option><option value="2.5">æˆä¹³æœŸ</option></optgroup>
                            </select></div>
                            <div><label for="cal-food-density" class="block text-sm font-medium text-gray-700">ãƒ•ãƒ¼ãƒ‰ã®ã‚«ãƒ­ãƒªãƒ¼ (kcal/100g)</label><input type="number" id="cal-food-density" class="mt-1 calc-input" placeholder="ä¾‹: 380"></div>
                        </div>`;
                    break;
                case 'bsa':
                     html += `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="bsa-species" class="block text-sm font-medium text-gray-700">å‹•ç‰©ç¨®</label><select id="bsa-species" class="mt-1 calc-input"><option value="dog">çŠ¬</option><option value="cat">çŒ«</option></select></div>
                            <div><label for="bsa-weight" class="block text-sm font-medium text-gray-700">ä½“é‡ (kg)</label><input type="number" id="bsa-weight" class="mt-1 calc-input" placeholder="ä¾‹: 10"></div>
                        </div>`;
                    break;
                case 'transfusion':
                    html += `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div><label for="tf-species" class="block text-sm font-medium text-gray-700">å‹•ç‰©ç¨®</label><select id="tf-species" class="mt-1 calc-input"><option value="dog">çŠ¬</option><option value="cat">çŒ«</option></select></div>
                            <div><label for="tf-weight" class="block text-sm font-medium text-gray-700">æ‚£è€…ã®ä½“é‡ (kg)</label><input type="number" id="tf-weight" class="mt-1 calc-input" placeholder="ä¾‹: 5"></div>
                            <div><label for="tf-patient-pcv" class="block text-sm font-medium text-gray-700">æ‚£è€…ã®PCV (%)</label><input type="number" id="tf-patient-pcv" class="mt-1 calc-input" placeholder="ä¾‹: 15"></div>
                            <div><label for="tf-target-pcv" class="block text-sm font-medium text-gray-700">ç›®æ¨™PCV (%)</label><input type="number" id="tf-target-pcv" class="mt-1 calc-input" placeholder="ä¾‹: 25"></div>
                             <div><label for="tf-donor-pcv" class="block text-sm font-medium text-gray-700">ä¾›è¡€å‹•ç‰©ã®PCV (%)</label><input type="number" id="tf-donor-pcv" class="mt-1 calc-input" placeholder="ä¾‹: 45"></div>
                        </div>`;
                    break;
                case 'cri_gamma':
                     html += `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="cri-g-conc" class="block text-sm font-medium text-gray-700">è–¬å‰¤æ¿ƒåº¦ (mg/mL)</label><input type="number" id="cri-g-conc" class="mt-1 calc-input" placeholder="ä¾‹: 20"></div>
                            <div><label for="cri-g-weight" class="block text-sm font-medium text-gray-700">ä½“é‡ (kg)</label><input type="number" id="cri-g-weight" class="mt-1 calc-input" placeholder="ä¾‹: 5"></div>
                            <div><label for="cri-g-rate" class="block text-sm font-medium text-gray-700">ç‚¹æ»´æµé‡ (mL/hr)</label><input type="number" id="cri-g-rate" class="mt-1 calc-input" placeholder="ä¾‹: 10"></div>
                            <div><label for="cri-g-total-vol" class="block text-sm font-medium text-gray-700">è¼¸æ¶²å…¨ä½“é‡ (mL)</label><input type="number" id="cri-g-total-vol" class="mt-1 calc-input" placeholder="ä¾‹: 250"></div>
                            <div><label for="cri-g-dose" class="block text-sm font-medium text-gray-700">æŠ•ä¸é‡ (Î¼g/kg/min)</label><input type="number" id="cri-g-dose" class="mt-1 calc-input" placeholder="ä¾‹: 5"></div>
                        </div>`;
                    break;
                case 'medication_exotic_oral':
                    html += `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="med-exo-weight" class="block text-sm font-medium text-gray-700">ä½“é‡ (g)</label><input type="number" id="med-exo-weight" class="mt-1 calc-input" placeholder="ä¾‹: 800"></div>
                            <div><label for="med-exo-dose" class="block text-sm font-medium text-gray-700">æŠ•ä¸é‡ (mg/kg)</label><input type="number" id="med-exo-dose" class="mt-1 calc-input" placeholder="ä¾‹: 5"></div>
                            <div><label for="med-exo-strength" class="block text-sm font-medium text-gray-700">è–¬å‰¤ã®å«æœ‰é‡ (mg/éŒ )</label><input type="number" id="med-exo-strength" class="mt-1 calc-input" placeholder="ä¾‹: 100"></div>
                            <div><label for="med-exo-drops" class="block text-sm font-medium text-gray-700">1å›ã‚ãŸã‚Šã®ç›®æ¨™æŠ•ä¸æ»´ä¸‹æ•°</label><input type="number" id="med-exo-drops" class="mt-1 calc-input" placeholder="ä¾‹: 2"></div>
                        </div>`;
                    break;
                case 'medication_exotic_water':
                    html += `
                        <div>
                            <div class="border-b border-gray-200"><nav class="-mb-px flex space-x-8" id="water-med-tabs"><a href="#" class="border-emerald-500 text-emerald-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="from_dose">æŠ•ä¸é‡ã‹ã‚‰è¨ˆç®—</a><a href="#" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="from_conc">ç›®æ¨™æ¿ƒåº¦ã‹ã‚‰è¨ˆç®—</a></nav></div>
                            <div id="tab-content-from_dose" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label for="wm-fd-weight" class="block text-sm font-medium text-gray-700">ä½“é‡ (g)</label><input type="number" id="wm-fd-weight" class="mt-1 calc-input" placeholder="ä¾‹: 40"></div>
                                <div><label for="wm-fd-dose" class="block text-sm font-medium text-gray-700">æŠ•ä¸é‡ (mg/kg/æ—¥)</label><input type="number" id="wm-fd-dose" class="mt-1 calc-input" placeholder="ä¾‹: 1"></div>
                                <div><label for="wm-fd-intake" class="block text-sm font-medium text-gray-700">1æ—¥ã®é£²æ°´é‡ (mL)</label><input type="number" id="wm-fd-intake" class="mt-1 calc-input" placeholder="ä¾‹: 4"></div>
                                <div><label for="wm-fd-strength" class="block text-sm font-medium text-gray-700">è–¬å‰¤ã®å«æœ‰é‡ (mg/éŒ  or g)</label><input type="number" id="wm-fd-strength" class="mt-1 calc-input" placeholder="ä¾‹: 10"></div>
                                <div><label for="wm-fd-volume" class="block text-sm font-medium text-gray-700">1åŒ…ã‚’æº¶è§£ã™ã‚‹æ°´ã®é‡ (mL)</label><input type="number" id="wm-fd-volume" class="mt-1 calc-input" placeholder="ä¾‹: 25"></div>
                                <div><label for="wm-fd-days" class="block text-sm font-medium text-gray-700">æŠ•ä¸æ—¥æ•° (æ—¥)</label><input type="number" id="wm-fd-days" class="mt-1 calc-input" placeholder="ä¾‹: 10"></div>
                            </div>
                            <div id="tab-content-from_conc" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                                <div><label for="wm-fc-conc" class="block text-sm font-medium text-gray-700">ç›®æ¨™æ¿ƒåº¦ (mg/L)</label><input type="number" id="wm-fc-conc" class="mt-1 calc-input" placeholder="ä¾‹: 10"></div>
                                <div><label for="wm-fc-strength" class="block text-sm font-medium text-gray-700">è–¬å‰¤ã®å«æœ‰é‡ (mg/éŒ  or g)</label><input type="number" id="wm-fc-strength" class="mt-1 calc-input" placeholder="ä¾‹: 10"></div>
                                <div><label for="wm-fc-volume" class="block text-sm font-medium text-gray-700">1åŒ…ã‚’æº¶è§£ã™ã‚‹æ°´ã®é‡ (mL)</label><input type="number" id="wm-fc-volume" class="mt-1 calc-input" placeholder="ä¾‹: 25"></div>
                                <div><label for="wm-fc-days" class="block text-sm font-medium text-gray-700">æŠ•ä¸æ—¥æ•° (æ—¥)</label><input type="number" id="wm-fc-days" class="mt-1 calc-input" placeholder="ä¾‹: 10"></div>
                            </div>
                        </div>`;
                    break;
            }
            
            html += `<div id="calc-result-${id}" class="calc-result-box hidden"></div></div>`;
            detailContent.innerHTML = html;
            
            document.getElementById(`calc-${id}`)?.addEventListener('input', () => calculate(id));
            if (id === 'medication_exotic_water') {
                document.getElementById('water-med-tabs').addEventListener('click', (e) => {
                    e.preventDefault();
                    const tab = e.target.closest('a');
                    if (!tab) return;
                    document.querySelectorAll('#water-med-tabs a').forEach(t => t.classList.remove('border-emerald-500', 'text-emerald-600'));
                    tab.classList.add('border-emerald-500', 'text-emerald-600');
                    document.getElementById('tab-content-from_dose').classList.toggle('hidden', tab.dataset.tab !== 'from_dose');
                    document.getElementById('tab-content-from_conc').classList.toggle('hidden', tab.dataset.tab !== 'from_conc');
                    calculate(id);
                });
            }
        }

        function calculate(id) {
            const resultBox = document.getElementById(`calc-result-${id}`);
            let inputs = {};
            let resultHtml = '';
            
            try {
                 switch(id) {
                    case 'calorie_dogcat':
                        inputs = {
                            w: parseFloat(document.getElementById('cal-weight').value),
                            f: parseFloat(document.getElementById('cal-factor').value),
                            d: parseFloat(document.getElementById('cal-food-density').value)
                        };
                        if (Object.values(inputs).some(isNaN) || inputs.w <= 0 || inputs.d <= 0) throw new Error();
                        
                        const rer = 70 * Math.pow(inputs.w, 0.75);
                        const der = rer * inputs.f;
                        const foodAmount = (der / inputs.d) * 100;

                        resultHtml = `
                            <h4 class="font-semibold text-lg mb-2">è¨ˆç®—çµæœ</h4>
                            <p><strong>å®‰é™æ™‚ã‚¨ãƒãƒ«ã‚®ãƒ¼è¦æ±‚é‡ (RER):</strong> ${rer.toFixed(1)} kcal/æ—¥</p>
                            <p><strong>1æ—¥ã‚ãŸã‚Šã®ã‚¨ãƒãƒ«ã‚®ãƒ¼è¦æ±‚é‡ (DER):</strong> ${der.toFixed(1)} kcal/æ—¥</p>
                            <p class="text-xl font-bold mt-2 text-emerald-700"><strong>1æ—¥ã®çµ¦ä¸é‡:</strong> ${foodAmount.toFixed(1)} g/æ—¥</p>
                            <h5 class="font-semibold mt-4 mb-1">è¨ˆç®—éç¨‹</h5>
                            <div class="calc-formula">
RER (kcal/æ—¥) = 70 * (ä½“é‡(kg) ^ 0.75)
  = 70 * (${inputs.w} ^ 0.75) = ${rer.toFixed(1)}

DER (kcal/æ—¥) = RER * æ´»å‹•ä¿‚æ•°
  = ${rer.toFixed(1)} * ${inputs.f} = ${der.toFixed(1)}
 
çµ¦ä¸é‡ (g/æ—¥) = DER / (ãƒ•ãƒ¼ãƒ‰kcal / 100g) * 100
  = ${der.toFixed(1)} / ${inputs.d} * 100 = ${foodAmount.toFixed(1)}
                            </div>`;
                        break;
                    case 'medication_exotic_oral':
                        inputs = {
                            w: parseFloat(document.getElementById('med-exo-weight').value) / 1000, // g to kg
                            dose: parseFloat(document.getElementById('med-exo-dose').value),
                            strength: parseFloat(document.getElementById('med-exo-strength').value),
                            drops: parseFloat(document.getElementById('med-exo-drops').value)
                        };
                        if (Object.values(inputs).some(isNaN) || inputs.w <= 0 || inputs.strength <= 0 || inputs.drops <= 0) throw new Error();

                        const requiredDoseMg = inputs.w * inputs.dose;
                        const doseVolumeMl = inputs.drops * 0.05;
                        const requiredConc = requiredDoseMg / doseVolumeMl;
                        const waterVolume = inputs.strength / requiredConc;

                        resultHtml = `
                            <h4 class="font-semibold text-lg mb-2">è¨ˆç®—çµæœ</h4>
                            <p><strong>1å›ã«å¿…è¦ãªè–¬å‰¤é‡:</strong> ${requiredDoseMg.toFixed(3)} mg</p>
                            <p><strong>ç›®æ¨™ã¨ã™ã‚‹æŠ•ä¸æ¶²é‡:</strong> ${doseVolumeMl.toFixed(3)} mL (${inputs.drops} æ»´)</p>
                            <p><strong>å¿…è¦ãªè–¬æ¶²æ¿ƒåº¦:</strong> ${requiredConc.toFixed(2)} mg/mL</p>
                            <p class="text-xl font-bold mt-2 text-emerald-700"><strong>${inputs.strength}mgã®è–¬å‰¤1éŒ </strong>ã‚’ <strong>${waterVolume.toFixed(2)} mL</strong> ã®æ°´ã«æº¶è§£ã—ã¦ãã ã•ã„ã€‚</p>
                            <h5 class="font-semibold mt-4 mb-1">è¨ˆç®—éç¨‹</h5>
                            <div class="calc-formula">
1å›ã«å¿…è¦ãªè–¬å‰¤é‡(mg) = ä½“é‡(kg) * æŠ•ä¸é‡(mg/kg)
  = ${inputs.w.toFixed(3)} * ${inputs.dose} = ${requiredDoseMg.toFixed(3)}

ç›®æ¨™æŠ•ä¸æ¶²é‡(mL) = ç›®æ¨™æ»´ä¸‹æ•° * 0.05
  = ${inputs.drops} * 0.05 = ${doseVolumeMl.toFixed(3)}

å¿…è¦ãªè–¬æ¶²æ¿ƒåº¦(mg/mL) = å¿…è¦ãªè–¬å‰¤é‡(mg) / ç›®æ¨™æŠ•ä¸æ¶²é‡(mL)
  = ${requiredDoseMg.toFixed(3)} / ${doseVolumeMl.toFixed(3)} = ${requiredConc.toFixed(2)}

æº¶è§£ã«å¿…è¦ãªæ°´ã®é‡(mL) = è–¬å‰¤ã®å«æœ‰é‡(mg) / å¿…è¦ãªè–¬æ¶²æ¿ƒåº¦(mg/mL)
  = ${inputs.strength} / ${requiredConc.toFixed(2)} = ${waterVolume.toFixed(2)}
                            </div>`;
                        break;
                    case 'medication_exotic_water':
                        const activeTab = document.querySelector('#water-med-tabs a.border-emerald-500').dataset.tab;
                        if (activeTab === 'from_dose') {
                            inputs = {
                                w: parseFloat(document.getElementById('wm-fd-weight').value) / 1000, // g to kg
                                dose: parseFloat(document.getElementById('wm-fd-dose').value),
                                intake: parseFloat(document.getElementById('wm-fd-intake').value) / 1000, // mL to L
                                strength: parseFloat(document.getElementById('wm-fd-strength').value),
                                volume: parseFloat(document.getElementById('wm-fd-volume').value) / 1000, // mL to L
                                days: parseInt(document.getElementById('wm-fd-days').value)
                            };
                            if (Object.values(inputs).some(isNaN) || inputs.w <= 0 || inputs.intake <= 0 || inputs.strength <= 0 || inputs.volume <= 0 || inputs.days <= 0) throw new Error();

                            const dailyDoseMg = inputs.w * inputs.dose;
                            const targetConc = dailyDoseMg / inputs.intake;
                            const drugPerBottle = targetConc * inputs.volume;
                            const totalDrug = drugPerBottle * inputs.days;
                            const totalTablets = totalDrug / inputs.strength;

                            resultHtml = `
                                <h4 class="font-semibold text-lg mb-2">è¨ˆç®—çµæœ</h4>
                                <p><strong>ç›®æ¨™æ¿ƒåº¦:</strong> ${targetConc.toFixed(2)} mg/L</p>
                                <p class="text-xl font-bold mt-2 text-emerald-700">è–¬å‰¤ <strong>${totalTablets.toFixed(2)} éŒ (or g)</strong> ã‚’ <strong>${inputs.days}åŒ…</strong> ã«åˆ†ã‘ã€<br>1åŒ…ã‚’1æ—¥1å›ã€é£²æ°´ ${inputs.volume * 1000} mLã«æ··ãœã¦æŠ•ä¸ã—ã¾ã™ã€‚</p>
                                <h5 class="font-semibold mt-4 mb-1">è¨ˆç®—éç¨‹</h5>
                                <div class="calc-formula">
1æ—¥ã®å¿…è¦è–¬å‰¤é‡(mg) = ä½“é‡(kg) * æŠ•ä¸é‡(mg/kg/æ—¥) = ${dailyDoseMg.toFixed(3)}
ç›®æ¨™æ¿ƒåº¦(mg/L) = 1æ—¥ã®å¿…è¦è–¬å‰¤é‡(mg) / 1æ—¥ã®é£²æ°´é‡(L) = ${targetConc.toFixed(2)}
1åŒ…ã‚ãŸã‚Šã®è–¬å‰¤é‡(mg) = ç›®æ¨™æ¿ƒåº¦(mg/L) * æº¶è§£ã™ã‚‹æ°´ã®é‡(L) = ${drugPerBottle.toFixed(3)}
ç·è–¬å‰¤é‡(mg) = 1åŒ…ã‚ãŸã‚Šã®è–¬å‰¤é‡(mg) * æŠ•ä¸æ—¥æ•° = ${totalDrug.toFixed(3)}
ç·éŒ å‰¤æ•°(éŒ ) = ç·è–¬å‰¤é‡(mg) / è–¬å‰¤ã®å«æœ‰é‡(mg) = ${totalTablets.toFixed(2)}
                                </div>`;

                        } else { // from_conc
                            inputs = {
                                conc: parseFloat(document.getElementById('wm-fc-conc').value),
                                strength: parseFloat(document.getElementById('wm-fc-strength').value),
                                volume: parseFloat(document.getElementById('wm-fc-volume').value) / 1000, // mL to L
                                days: parseInt(document.getElementById('wm-fc-days').value)
                            };
                             if (Object.values(inputs).some(isNaN) || inputs.conc <= 0 || inputs.strength <= 0 || inputs.volume <= 0 || inputs.days <= 0) throw new Error();
                            
                            const drugPerBottle_fc = inputs.conc * inputs.volume;
                            const totalDrug_fc = drugPerBottle_fc * inputs.days;
                            const totalTablets_fc = totalDrug_fc / inputs.strength;

                             resultHtml = `
                                <h4 class="font-semibold text-lg mb-2">è¨ˆç®—çµæœ</h4>
                                <p class="text-xl font-bold mt-2 text-emerald-700">è–¬å‰¤ <strong>${totalTablets_fc.toFixed(2)} éŒ (or g)</strong> ã‚’ <strong>${inputs.days}åŒ…</strong> ã«åˆ†ã‘ã€<br>1åŒ…ã‚’1æ—¥1å›ã€é£²æ°´ ${inputs.volume * 1000} mLã«æ··ãœã¦æŠ•ä¸ã—ã¾ã™ã€‚</p>
                                <h5 class="font-semibold mt-4 mb-1">è¨ˆç®—éç¨‹</h5>
                                <div class="calc-formula">
1åŒ…ã‚ãŸã‚Šã®è–¬å‰¤é‡(mg) = ç›®æ¨™æ¿ƒåº¦(mg/L) * æº¶è§£ã™ã‚‹æ°´ã®é‡(L) = ${drugPerBottle_fc.toFixed(3)}
ç·è–¬å‰¤é‡(mg) = 1åŒ…ã‚ãŸã‚Šã®è–¬å‰¤é‡(mg) * æŠ•ä¸æ—¥æ•° = ${totalDrug_fc.toFixed(3)}
ç·éŒ å‰¤æ•°(éŒ ) = ç·è–¬å‰¤é‡(mg) / è–¬å‰¤ã®å«æœ‰é‡(mg) = ${totalTablets_fc.toFixed(2)}
                                </div>`;
                        }
                        break;
                    
                    case 'bsa':
                        inputs = {
                            w: parseFloat(document.getElementById('bsa-weight').value),
                            s: document.getElementById('bsa-species').value
                        };
                        if (isNaN(inputs.w) || inputs.w <= 0) throw new Error();
                        const k = inputs.s === 'dog' ? 10.1 : 10.0;
                        const bsa = k * Math.pow(inputs.w * 1000, 2/3) / 10000;

                        resultHtml = `
                            <h4 class="font-semibold text-lg mb-2">è¨ˆç®—çµæœ</h4>
                            <p class="text-xl font-bold mt-2 text-emerald-700"><strong>ä½“è¡¨é¢ç© (BSA):</strong> ${bsa.toFixed(4)} mÂ²</p>
                            <h5 class="font-semibold mt-4 mb-1">è¨ˆç®—éç¨‹</h5>
                            <div class="calc-formula">
BSA (mÂ²) = (K * (ä½“é‡(g) ^ (2/3))) / 10000
  = (${k} * ((${inputs.w}*1000) ^ (2/3))) / 10000 = ${bsa.toFixed(4)}
                            </div>
                            <div class="mt-6">
                                <h4 class="font-semibold text-lg mb-2">BSAæ—©è¦‹è¡¨</h4>
                                <div class="table-container">
                                    <table class="custom-table text-sm">
                                        <thead><tr><th>ä½“é‡(kg)</th><th>BSA(mÂ²)</th><th>ä½“é‡(kg)</th><th>BSA(mÂ²)</th><th>ä½“é‡(kg)</th><th>BSA(mÂ²)</th></tr></thead>
                                        <tbody id="bsa-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                            `;
                        break;

                    case 'transfusion':
                        inputs = {
                            s: document.getElementById('tf-species').value,
                            w: parseFloat(document.getElementById('tf-weight').value),
                            pPCV: parseFloat(document.getElementById('tf-patient-pcv').value),
                            tPCV: parseFloat(document.getElementById('tf-target-pcv').value),
                            dPCV: parseFloat(document.getElementById('tf-donor-pcv').value)
                        };
                        if (Object.values(inputs).slice(1).some(isNaN)) throw new Error();
                        const bloodVolConstant = inputs.s === 'dog' ? 90 : 70;
                        const requiredBlood = (inputs.w * bloodVolConstant * (inputs.tPCV - inputs.pPCV)) / inputs.dPCV;

                        resultHtml = `
                            <h4 class="font-semibold text-lg mb-2">è¨ˆç®—çµæœ</h4>
                            <p class="text-xl font-bold mt-2 text-emerald-700"><strong>å¿…è¦è¡€æ¶²é‡:</strong> ${requiredBlood.toFixed(1)} mL</p>
                            <h5 class="font-semibold mt-4 mb-1">è¨ˆç®—éç¨‹</h5>
                            <div class="calc-formula">
å¿…è¦è¡€æ¶²é‡(mL) = (ä½“é‡(kg) * è¡€æ¶²é‡ä¿‚æ•° * (ç›®æ¨™PCV - æ‚£è€…PCV)) / ä¾›è¡€å‹•ç‰©PCV
  = (${inputs.w} * ${bloodVolConstant} * (${inputs.tPCV} - ${inputs.pPCV})) / ${inputs.dPCV} = ${requiredBlood.toFixed(1)}
                            </div>`;
                        break;

                    case 'cri_gamma':
                        inputs = {
                            conc: parseFloat(document.getElementById('cri-g-conc').value),
                            w: parseFloat(document.getElementById('cri-g-weight').value),
                            rate: parseFloat(document.getElementById('cri-g-rate').value),
                            vol: parseFloat(document.getElementById('cri-g-total-vol').value),
                            dose: parseFloat(document.getElementById('cri-g-dose').value)
                        };
                        if (Object.values(inputs).some(isNaN)) throw new Error();
                        const drugAmountMl = (inputs.dose * inputs.w * inputs.vol * 60) / (inputs.conc * 1000 * inputs.rate);

                        resultHtml = `
                            <h4 class="font-semibold text-lg mb-2">è¨ˆç®—çµæœ</h4>
                            <p>è¼¸æ¶²${inputs.vol}mLã«è–¬å‰¤ã‚’ <strong class="text-xl text-emerald-700">${drugAmountMl.toFixed(2)} mL</strong> æ·»åŠ ã—ã€<br><strong>${inputs.rate} mL/hr</strong> ã®æµé‡ã§æŠ•ä¸ã—ã¾ã™ã€‚</p>
                            <h5 class="font-semibold mt-4 mb-1">è¨ˆç®—éç¨‹</h5>
                            <div class="calc-formula">
è–¬å‰¤é‡(mL) = (æŠ•ä¸é‡(Î¼g/kg/min) * ä½“é‡(kg) * å…¨ä½“é‡(mL) * 60) / (è–¬å‰¤æ¿ƒåº¦(mg/mL) * 1000 * ç‚¹æ»´æµé‡(mL/hr))
  = (${inputs.dose} * ${inputs.w} * ${inputs.vol} * 60) / (${inputs.conc} * 1000 * ${inputs.rate}) = ${drugAmountMl.toFixed(2)}
                            </div>`;
                        break;
                }
                resultBox.innerHTML = resultHtml;
                resultBox.classList.remove('hidden');

                if (id === 'bsa') {
                    generateBsaTable(inputs.s);
                }

            } catch (e) {
                resultBox.classList.add('hidden');
            }
        }

        function generateBsaTable(species) {
            const tableBody = document.getElementById('bsa-table-body');
            if (!tableBody) return;
            const k = species === 'dog' ? 10.1 : 10.0;
            const weights = [1,2,3,4,5,6,7,8,9,10,12,14,16,18,20,25,30,35,40,45,50,55,60];
            let tableHtml = '';
            for(let i = 0; i < weights.length; i += 3) {
                tableHtml += '<tr>';
                for(let j = 0; j < 3; j++) {
                    const weight = weights[i+j];
                    if(weight) {
                        const bsa = k * Math.pow(weight * 1000, 2/3) / 10000;
                        tableHtml += `<td><strong>${weight}kg</strong></td><td>${bsa.toFixed(3)} mÂ²</td>`;
                    } else {
                        tableHtml += '<td></td><td></td>';
                    }
                }
                tableHtml += '</tr>';
            }
            tableBody.innerHTML = tableHtml;
        }

        init();

    </script>
</body>
</html>
