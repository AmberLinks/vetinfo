<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç£åŒ»ç™‚ æ•‘æ€¥ç–¾æ‚£ï¼†è¨ˆç®—ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .content-section h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            margin-top: 1.75rem; /* mt-7 */
            margin-bottom: 0.75rem; /* mb-3 */
            padding-bottom: 0.5rem; /* pb-2 */
            border-bottom: 2px solid #34d399; /* border-b-2 border-emerald-400 */
            color: #047857; /* text-emerald-700 */
        }
        .content-section ul { list-style-type: disc; padding-left: 1.75rem; margin-top: 0.5rem; }
        .content-section li { margin-bottom: 0.5rem; }
        
        /* Table styles */
        .table-container { overflow-x: auto; margin-top: 1rem; }
        .custom-table { width: 100%; border-collapse: collapse; }
        .custom-table th, .custom-table td { border: 1px solid #d1d5db; padding: 0.75rem; text-align: left; }
        .custom-table th { background-color: #f3f4f6; font-weight: 600; }
        .custom-table tr:nth-child(even) { background-color: #f9fafb; }

        /* Calculator styles */
        .calc-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .calc-input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }
        .calc-result-box {
            background-color: #f0fdfa; /* emerald-50 */
            border: 1px solid #a7f3d0; /* emerald-200 */
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1.5rem;
        }
        .calc-formula {
            background-color: #e5e7eb; /* gray-200 */
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.9rem;
        }
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Hide elements helper */
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex h-screen overflow-hidden">
        <nav id="sidebar" class="w-16 md:w-56 bg-gray-800 text-white flex flex-col transition-all duration-300 flex-shrink-0">
            <div class="px-4 py-5 border-b border-gray-700 flex items-center justify-center md:justify-start">
                <svg class="h-8 w-8 text-emerald-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-9-5.747h18"/>
                </svg>
                <h1 class="text-xl font-bold ml-3 hidden md:block">Vet Guide</h1>
            </div>
            <ul id="nav-list" class="flex-grow overflow-y-auto">
                </ul>
             <div class="px-4 py-3 border-t border-gray-700">
                <p class="text-xs text-gray-500 text-center hidden md:block">&copy; 2024 Vet Emergency Guide</p>
            </div>
        </nav>

        <main class="flex-1 flex overflow-hidden">
            <div id="list-panel" class="w-full md:w-1/4 lg:w-1/5 bg-white border-r border-gray-200 overflow-y-auto flex-shrink-0">
                 <div class="p-4 border-b border-gray-200 sticky top-0 bg-white z-10">
                    <h2 id="category-title" class="text-xl font-bold text-gray-700">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</h2>
                </div>
                <ul id="item-list">
                    </ul>
            </div>

            <div id="detail-panel" class="flex-1 overflow-y-auto p-6 md:p-8 lg:p-10">
                <div id="detail-content">
                    </div>
            </div>
        </main>
    </div>

    <script>
        // --- microCMS Configuration ---
        const MICROCMS_CONFIG = {
            apiKey: '66U37gIl7UHa9gJqv5OyV3OI6IbBh5Awu7jS', // å®Ÿéš›ã®APIã‚­ãƒ¼ã«ç½®ãæ›ãˆã¦ãã ã•ã„
            serviceDomain: 'vetinfo'
        };

        // --- SPA-Managed Data (Calculators) ---
        const calculatorDefinitions = {
            "çŠ¬ãƒ»çŒ«": {
                "è¨ˆç®—ãƒ„ãƒ¼ãƒ«": {
                    "æ „é¤Šè¨ˆç®— (RER/DER)": { "type": "calculator", "id": "calorie_dogcat_detailed" },
                    "ä½“è¡¨é¢ç© (BSA)": { "type": "calculator", "id": "bsa" },
                    "è¼¸è¡€é‡è¨ˆç®—": { "type": "calculator", "id": "transfusion" },
                    "CRIè¨ˆç®— (Î¼g/kg/min)": { "type": "calculator", "id": "cri_gamma" },
                }
            },
            "ã‚¨ã‚­ã‚¾ãƒãƒƒã‚¯ã‚¢ãƒ‹ãƒãƒ«": {
                 "è¨ˆç®—ãƒ„ãƒ¼ãƒ«": {
                    "çµŒå£æŠ•è–¬é‡è¨ˆç®—": { "type": "calculator", "id": "medication_exotic_oral" },
                    "é£²æ°´æŠ•è–¬é‡è¨ˆç®—": { "type": "calculator", "id": "medication_exotic_water" }
                }
            }
        };

        // --- Global State ---
        let contentData = {}; // This will be populated from microCMS
        let activeMajorCategory = null;
        let activeSubCategory = null;
        let activeItem = null;

        // --- DOM Elements ---
        const navList = document.getElementById('nav-list');
        const categoryTitle = document.getElementById('category-title');
        const itemList = document.getElementById('item-list');
        const detailContent = document.getElementById('detail-content');

        // --- Data Fetching & Processing ---
        async function fetchMicroCMSData() {
            setLoading(detailContent);
            try {
                const response = await fetch(`https://${MICROCMS_CONFIG.serviceDomain}.microcms.io/api/v1/articles?limit=100&depth=2`, {
                    headers: { 'X-MICROCMS-API-KEY': MICROCMS_CONFIG.apiKey }
                });
                if (!response.ok) throw new Error(`API fetch failed: ${response.status}`);
                const data = await response.json();
                return processFetchedData(data.contents);
            } catch (error) {
                console.error("Failed to fetch from microCMS:", error);
                setError(detailContent, "ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã¨ã‚µãƒ¼ãƒ“ã‚¹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                return {};
            }
        }

        function processFetchedData(articles) {
            const processedData = {};
            articles.forEach(article => {
                const majorCat = article.animal_group?.group_name;
                const subCat = article.content_category?.category_name;
                if (!majorCat || !subCat) return;

                if (!processedData[majorCat]) processedData[majorCat] = {};
                if (!processedData[majorCat][subCat]) processedData[majorCat][subCat] = {};
                
                if (majorCat === "ã‚¨ã‚­ã‚¾ãƒãƒƒã‚¯ã‚¢ãƒ‹ãƒãƒ«" && subCat === "æ•‘æ€¥ç–¾æ‚£" && article.exotic_species) {
                    const species = article.exotic_species.species_name;
                    if (!processedData[majorCat][subCat][species]) {
                        processedData[majorCat][subCat][species] = {};
                    }
                    processedData[majorCat][subCat][species][article.title] = article;
                } else {
                    processedData[majorCat][subCat][article.title] = article;
                }
            });
            return processedData;
        }

        // --- Rendering Functions ---
        function renderNavigation() {
            navList.innerHTML = '';
            const majorCategories = { "çŠ¬ãƒ»çŒ«": "ğŸ¾", "ã‚¨ã‚­ã‚¾ãƒãƒƒã‚¯ã‚¢ãƒ‹ãƒãƒ«": "ğŸ‡" };
            
            Object.keys(majorCategories).forEach(cat => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <a href="#" class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors duration-200" data-major-category="${cat}">
                        <span class="w-8 text-center text-lg">${majorCategories[cat]}</span>
                        <span class="ml-3 hidden md:inline">${cat}</span>
                    </a>
                `;
                navList.appendChild(li);
            });
        }

        function renderSubCategoryList(majorCat) {
            categoryTitle.textContent = majorCat;
            const contentSubCats = contentData[majorCat] ? Object.keys(contentData[majorCat]) : [];
            const calcSubCats = calculatorDefinitions[majorCat] ? Object.keys(calculatorDefinitions[majorCat]) : [];
            const allSubCats = [...new Set([...contentSubCats, ...calcSubCats])];

            itemList.innerHTML = allSubCats.map(subCat => `
                <li>
                    <a href="#" class="block px-4 py-3 text-gray-700 hover:bg-emerald-50 border-b border-gray-100" data-major-category="${majorCat}" data-sub-category="${subCat}">
                        ${subCat}
                    </a>
                </li>
            `).join('');
        }

        function renderItemList(majorCat, subCat, species = null) {
            let path = `${majorCat} > ${subCat}`;
            if (species) {
                path += ` > ${species}`;
            }
            categoryTitle.textContent = path;

            const isCalc = calculatorDefinitions[majorCat] && calculatorDefinitions[majorCat][subCat];
            let dataRoot = isCalc ? calculatorDefinitions[majorCat][subCat] : contentData[majorCat][subCat];
            if (species) {
                dataRoot = dataRoot[species];
            }
            const items = Object.keys(dataRoot || {});

            let listHtml = `<li><a href="#" class="block px-4 py-3 font-bold text-emerald-600 hover:bg-emerald-50 border-b border-gray-100" data-major-category="${majorCat}" data-sub-category="BACK" data-species="${species || ''}">â† æˆ»ã‚‹</a></li>`;
            
            listHtml += items.map(item => `
                <li>
                    <a href="#" class="block px-4 py-3 text-gray-700 hover:bg-emerald-50 border-b border-gray-100" data-major-category="${majorCat}" data-sub-category="${subCat}" data-item="${item}" data-species="${species || ''}">
                        ${item}
                    </a>
                </li>
            `).join('');
            itemList.innerHTML = listHtml;
        }
        
        function renderDetail(majorCat, subCat, itemName, species = null) {
            const isCalc = calculatorDefinitions[majorCat] && calculatorDefinitions[majorCat][subCat];
            let data;
            let titlePath = `${majorCat} > ${subCat}`;

            if (isCalc) {
                data = calculatorDefinitions[majorCat][subCat][itemName];
            } else {
                data = species ? contentData[majorCat][subCat][species][itemName] : contentData[majorCat][subCat][itemName];
                if (species) {
                    titlePath += ` > ${species}`;
                }
            }
            
            if (!data) {
                setError(detailContent, "ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                return;
            }

            if (data.type === 'calculator') {
                renderCalculator(itemName, data.id);
                return;
            }

            let contentHtml = `<h2 class="text-3xl font-bold text-gray-800 mb-2">${data.title}</h2>`;
            contentHtml += `<p class="text-sm text-gray-500 mb-6">ã‚«ãƒ†ã‚´ãƒª: ${titlePath}</p>`;

            if (data.overview) {
                 contentHtml += `<div class="content-section"><h3>æ¦‚è¦</h3><p class="text-gray-700 leading-relaxed">${data.overview}</p></div>`;
            }
            if (data.body) {
                contentHtml += `<div class="content-section"><h3>è©³ç´°</h3>${data.body}</div>`;
            }

            detailContent.innerHTML = contentHtml;
        }

        // --- UI State Functions ---
        function setWelcomeMessage() {
            detailContent.innerHTML = `
                <div class="text-center py-20">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" /></svg>
                    <h3 class="mt-2 text-lg font-medium text-gray-900">ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
                    <p class="mt-1 text-sm text-gray-500">å·¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã¨é …ç›®ã‚’é¸æŠã™ã‚‹ã¨ã€ã“ã“ã«è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                </div>`;
        }

        function setLoading(element) {
            element.innerHTML = '<div class="loader"></div>';
        }

        function setError(element, message) {
            element.innerHTML = `<div class="text-center py-20 text-red-600">${message}</div>`;
        }
        
        // --- Event Handlers ---
        navList.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (!link) return;
            e.preventDefault();

            const majorCat = link.dataset.majorCategory;
            if (activeMajorCategory === majorCat) return;

            activeMajorCategory = majorCat;
            activeSubCategory = null;
            activeItem = null;

            document.querySelectorAll('#nav-list a').forEach(a => a.classList.remove('bg-gray-700', 'text-white'));
            link.classList.add('bg-gray-700', 'text-white');

            renderSubCategoryList(majorCat);
            setWelcomeMessage();
        });

        itemList.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (!link) return;
            e.preventDefault();

            const majorCat = link.dataset.majorCategory;
            const subCat = link.dataset.subCategory;
            const itemName = link.dataset.item;
            const species = link.dataset.species;

            if (subCat === 'BACK') {
                if (species) {
                    renderItemList(majorCat, "æ•‘æ€¥ç–¾æ‚£");
                } else {
                    activeSubCategory = null;
                    renderSubCategoryList(majorCat);
                }
                activeItem = null;
                setWelcomeMessage();
                return;
            }

            if (itemName) {
                if (majorCat === "ã‚¨ã‚­ã‚¾ãƒãƒƒã‚¯ã‚¢ãƒ‹ãƒãƒ«" && subCat === "æ•‘æ€¥ç–¾æ‚£" && !species) {
                    renderItemList(majorCat, subCat, itemName); 
                    setWelcomeMessage();
                } else {
                    if (activeItem === itemName && activeSubCategory === subCat) return;
                    activeItem = itemName;
                    activeSubCategory = subCat;
                    document.querySelectorAll('#item-list a').forEach(a => a.classList.remove('bg-emerald-100', 'font-semibold'));
                    link.classList.add('bg-emerald-100', 'font-semibold');
                    renderDetail(majorCat, subCat, itemName, species);
                }
            } else {
                if (activeSubCategory === subCat) return;
                activeSubCategory = subCat;
                activeItem = null;
                renderItemList(majorCat, subCat);
                setWelcomeMessage();
            }
        });

        // --- Initialization ---
        async function init() {
            renderNavigation();
            setWelcomeMessage();
            contentData = await fetchMicroCMSData();
            
            const firstCategoryLink = navList.querySelector('a');
            if (firstCategoryLink) {
                firstCategoryLink.click();
            }
        }
        
        // =================================================================
        // --- Calculator Rendering & Logic ---
        // =================================================================

        function renderCalculator(title, id) {
             let html = `<h2 class="text-3xl font-bold text-gray-800 mb-6">${title}</h2>`;
            html += `<div id="calc-${id}" class="space-y-4">`;
            
            switch(id) {
                case 'calorie_dogcat_detailed':
                    html += `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4">
                            <div><label for="species" class="block text-sm font-medium text-gray-700">å‹•ç‰©ç¨®</label>
                                <select id="species" class="mt-1 calc-input">
                                    <option value="dog">çŠ¬</option>
                                    <option value="cat">çŒ«</option>
                                </select>
                            </div>
                            <div><label for="bw_kg" class="block text-sm font-medium text-gray-700">ä½“é‡ (kg)</label>
                                <input type="number" id="bw_kg" class="mt-1 calc-input" placeholder="ä¾‹: 10">
                            </div>
                            <div><label for="purpose" class="block text-sm font-medium text-gray-700">ç›®çš„ / ãƒ©ã‚¤ãƒ•ã‚¹ãƒ†ãƒ¼ã‚¸</label>
                                <select id="purpose" class="mt-1 calc-input">
                                    <option value="maintenance">æˆçŠ¬/æˆçŒ« (ç¶­æŒ)</option>
                                    <option value="growth">æˆé•·æœŸ</option>
                                    <option value="weight_loss">æ¸›é‡</option>
                                    <option value="gestation">å¦Šå¨ æœŸ</option>
                                    <option value="lactation">æˆä¹³æœŸ</option>
                                    <option value="critical_care">å…¥é™¢ / ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«</option>
                                </select>
                            </div>
                            
                            <div id="maintenance-options" class="">
                                <label for="neuter_status" class="block text-sm font-medium text-gray-700">é¿å¦Š/å»å‹¢</label>
                                <select id="neuter_status" class="mt-1 calc-input">
                                    <option value="neutered">å»å‹¢æ¸ˆ</option>
                                    <option value="intact">æœªå»å‹¢</option>
                                </select>
                                <div class="mt-4"><label class="flex items-center"><input type="checkbox" id="obesity_prone" class="h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
                                <span class="ml-2 text-sm text-gray-600">è‚¥æº€å‚¾å‘ / ä½æ´»å‹•</span></label></div>
                            </div>

                            <div id="growth-options" class="hidden">
                                <label for="age_stage" class="block text-sm font-medium text-gray-700">æˆé•·æ®µéš</label>
                                <select id="age_stage" class="mt-1 calc-input">
                                    <option value="puppy_young">&lt; 4ãƒ¶æœˆé½¢ (çŠ¬)</option>
                                    <option value="puppy_old">&ge; 4ãƒ¶æœˆé½¢ (çŠ¬)</option>
                                    <option value="kitten">å­çŒ«</option>
                                </select>
                            </div>

                            <div id="lactation-options" class="hidden">
                                <label for="litter_size" class="block text-sm font-medium text-gray-700">å­ã®æ•° (é ­)</label>
                                <input type="number" id="litter_size" class="mt-1 calc-input" placeholder="ä¾‹: 3">
                            </div>
                            
                            <div>
                                <label for="rer_formula" class="block text-sm font-medium text-gray-700">RERè¨ˆç®—å¼</label>
                                <select id="rer_formula" class="mt-1 calc-input">
                                    <option value="exponential">æŒ‡æ•°å¼: 70 * (ä½“é‡^0.75)</option>
                                    <option value="linear">ç·šå½¢å¼: 30 * ä½“é‡ + 70</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">ç·šå½¢å¼ã¯2-45kgã§ã®ä½¿ç”¨ã‚’æ¨å¥¨</p>
                            </div>
                            <div><label for="food_density" class="block text-sm font-medium text-gray-700">ãƒ•ãƒ¼ãƒ‰ã®ã‚«ãƒ­ãƒªãƒ¼ (kcal/100g)</label>
                                <input type="number" id="food_density" class="mt-1 calc-input" placeholder="ä¾‹: 380">
                            </div>
                        </div>
                    `;
                    break;
                case 'bsa':
                     html += `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="bsa-species" class="block text-sm font-medium text-gray-700">å‹•ç‰©ç¨®</label><select id="bsa-species" class="mt-1 calc-input"><option value="dog">çŠ¬</option><option value="cat">çŒ«</option></select></div>
                            <div><label for="bsa-weight" class="block text-sm font-medium text-gray-700">ä½“é‡ (kg)</label><input type="number" id="bsa-weight" class="mt-1 calc-input" placeholder="ä¾‹: 10"></div>
                        </div>`;
                    break;
                case 'transfusion':
                    html += `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <div><label for="tf-species" class="block text-sm font-medium text-gray-700">å—è¡€å‹•ç‰©</label>
                                <select id="tf-species" class="mt-1 calc-input"><option value="dog">çŠ¬</option><option value="cat">çŒ«</option></select>
                            </div>
                            <div>
                                <label for="tf-blood-volume" class="block text-sm font-medium text-gray-700">å¾ªç’°è¡€æ¶²é‡ (mL/kg)</label>
                                <input type="number" id="tf-blood-volume" class="mt-1 calc-input" value="90">
                                <div id="tf-blood-volume-info" class="text-xs text-gray-500 mt-1"></div>
                            </div>
                            <div><label for="tf-weight" class="block text-sm font-medium text-gray-700">å—è¡€å‹•ç‰©ã®ä½“é‡ (kg)</label>
                                <input type="number" id="tf-weight" class="mt-1 calc-input" placeholder="ä¾‹: 20">
                            </div>
                            <div><label for="tf-patient-pcv" class="block text-sm font-medium text-gray-700">ç¾åœ¨PCV (%)</label>
                                <input type="number" id="tf-patient-pcv" class="mt-1 calc-input" placeholder="ä¾‹: 15">
                            </div>
                            <div><label for="tf-target-pcv" class="block text-sm font-medium text-gray-700">ç›®æ¨™PCV (%)</label>
                                <input type="number" id="tf-target-pcv" class="mt-1 calc-input" placeholder="ä¾‹: 25">
                            </div>
                            <div><label for="tf-donor-pcv" class="block text-sm font-medium text-gray-700">ãƒ‰ãƒŠãƒ¼PCV (%)</label>
                                <input type="number" id="tf-donor-pcv" class="mt-1 calc-input" placeholder="ä¾‹: 40">
                            </div>
                        </div>`;
                    break;
                case 'cri_gamma':
                     html += `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="cri-g-conc" class="block text-sm font-medium text-gray-700">è–¬å‰¤æ¿ƒåº¦ (mg/mL)</label><input type="number" id="cri-g-conc" class="mt-1 calc-input" placeholder="ä¾‹: 20"></div>
                            <div><label for="cri-g-weight" class="block text-sm font-medium text-gray-700">ä½“é‡ (kg)</label><input type="number" id="cri-g-weight" class="mt-1 calc-input" placeholder="ä¾‹: 5"></div>
                            <div><label for="cri-g-rate" class="block text-sm font-medium text-gray-700">ç‚¹æ»´æµé‡ (mL/hr)</label><input type="number" id="cri-g-rate" class="mt-1 calc-input" placeholder="ä¾‹: 10"></div>
                            <div><label for="cri-g-total-vol" class="block text-sm font-medium text-gray-700">è¼¸æ¶²å…¨ä½“é‡ (mL)</label><input type="number" id="cri-g-total-vol" class="mt-1 calc-input" placeholder="ä¾‹: 250"></div>
                            <div><label for="cri-g-dose" class="block text-sm font-medium text-gray-700">æŠ•ä¸é‡ (Î¼g/kg/min)</label><input type="number" id="cri-g-dose" class="mt-1 calc-input" placeholder="ä¾‹: 5"></div>
                        </div>`;
                    break;
                case 'medication_exotic_oral':
                    html += `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="med-exo-weight" class="block text-sm font-medium text-gray-700">ä½“é‡ (g)</label><input type="number" id="med-exo-weight" class="mt-1 calc-input" placeholder="ä¾‹: 800"></div>
                            <div><label for="med-exo-dose" class="block text-sm font-medium text-gray-700">æŠ•ä¸é‡ (mg/kg)</label><input type="number" id="med-exo-dose" class="mt-1 calc-input" placeholder="ä¾‹: 5"></div>
                            <div><label for="med-exo-strength" class="block text-sm font-medium text-gray-700">è–¬å‰¤ã®å«æœ‰é‡ (mg/éŒ )</label><input type="number" id="med-exo-strength" class="mt-1 calc-input" placeholder="ä¾‹: 100"></div>
                            <div><label for="med-exo-drops" class="block text-sm font-medium text-gray-700">1å›ã‚ãŸã‚Šã®ç›®æ¨™æŠ•ä¸æ»´ä¸‹æ•°</label><input type="number" id="med-exo-drops" class="mt-1 calc-input" placeholder="ä¾‹: 2"></div>
                        </div>`;
                    break;
                case 'medication_exotic_water':
                    html += `
                        <div>
                            <div class="border-b border-gray-200"><nav class="-mb-px flex space-x-8" id="water-med-tabs"><a href="#" class="border-emerald-500 text-emerald-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="from_dose">æŠ•ä¸é‡ã‹ã‚‰è¨ˆç®—</a><a href="#" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="from_conc">ç›®æ¨™æ¿ƒåº¦ã‹ã‚‰è¨ˆç®—</a></nav></div>
                            <div id="tab-content-from_dose" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label for="wm-fd-weight" class="block text-sm font-medium text-gray-700">ä½“é‡ (g)</label><input type="number" id="wm-fd-weight" class="mt-1 calc-input" placeholder="ä¾‹: 40"></div>
                                <div><label for="wm-fd-dose" class="block text-sm font-medium text-gray-700">æŠ•ä¸é‡ (mg/kg/æ—¥)</label><input type="number" id="wm-fd-dose" class="mt-1 calc-input" placeholder="ä¾‹: 1"></div>
                                <div><label for="wm-fd-intake" class="block text-sm font-medium text-gray-700">1æ—¥ã®é£²æ°´é‡ (mL)</label><input type="number" id="wm-fd-intake" class="mt-1 calc-input" placeholder="ä¾‹: 4"></div>
                                <div><label for="wm-fd-strength" class="block text-sm font-medium text-gray-700">è–¬å‰¤ã®å«æœ‰é‡ (mg/éŒ  or g)</label><input type="number" id="wm-fd-strength" class="mt-1 calc-input" placeholder="ä¾‹: 10"></div>
                                <div><label for="wm-fd-volume" class="block text-sm font-medium text-gray-700">1åŒ…ã‚’æº¶è§£ã™ã‚‹æ°´ã®é‡ (mL)</label><input type="number" id="wm-fd-volume" class="mt-1 calc-input" placeholder="ä¾‹: 25"></div>
                                <div><label for="wm-fd-days" class="block text-sm font-medium text-gray-700">æŠ•ä¸æ—¥æ•° (æ—¥)</label><input type="number" id="wm-fd-days" class="mt-1 calc-input" placeholder="ä¾‹: 10"></div>
                            </div>
                            <div id="tab-content-from_conc" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                                <div><label for="wm-fc-conc" class="block text-sm font-medium text-gray-700">ç›®æ¨™æ¿ƒåº¦ (mg/L)</label><input type="number" id="wm-fc-conc" class="mt-1 calc-input" placeholder="ä¾‹: 10"></div>
                                <div><label for="wm-fc-strength" class="block text-sm font-medium text-gray-700">è–¬å‰¤ã®å«æœ‰é‡ (mg/éŒ  or g)</label><input type="number" id="wm-fc-strength" class="mt-1 calc-input" placeholder="ä¾‹: 10"></div>
                                <div><label for="wm-fc-volume" class="block text-sm font-medium text-gray-700">1åŒ…ã‚’æº¶è§£ã™ã‚‹æ°´ã®é‡ (mL)</label><input type="number" id="wm-fc-volume" class="mt-1 calc-input" placeholder="ä¾‹: 25"></div>
                                <div><label for="wm-fc-days" class="block text-sm font-medium text-gray-700">æŠ•ä¸æ—¥æ•° (æ—¥)</label><input type="number" id="wm-fc-days" class="mt-1 calc-input" placeholder="ä¾‹: 10"></div>
                            </div>
                        </div>`;
                    break;
            }
            
            html += `<div id="calc-result-${id}" class="calc-result-box hidden"></div></div>`;
            detailContent.innerHTML = html;
            
            const calcContainer = document.getElementById(`calc-${id}`);
            if (calcContainer) {
                calcContainer.addEventListener('input', () => calculate(id));
                if (id === 'calorie_dogcat_detailed') {
                    document.getElementById('purpose').addEventListener('change', updateCalculatorUI);
                    document.getElementById('species').addEventListener('change', updateCalculatorUI);
                    updateCalculatorUI();
                }
                if (id === 'transfusion') {
                    document.getElementById('tf-species').addEventListener('change', () => updateTransfusionUI(id));
                    updateTransfusionUI(id);
                }
                if (id === 'medication_exotic_water') {
                    document.getElementById('water-med-tabs').addEventListener('click', (e) => {
                        e.preventDefault();
                        const tab = e.target.closest('a');
                        if (!tab) return;
                        document.querySelectorAll('#water-med-tabs a').forEach(t => {
                            t.classList.remove('border-emerald-500', 'text-emerald-600');
                            t.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                        });
                        tab.classList.add('border-emerald-500', 'text-emerald-600');
                        tab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                        document.getElementById('tab-content-from_dose').classList.toggle('hidden', tab.dataset.tab !== 'from_dose');
                        document.getElementById('tab-content-from_conc').classList.toggle('hidden', tab.dataset.tab !== 'from_conc');
                        calculate(id);
                    });
                }
            }
        }

        function updateCalculatorUI() {
            const purpose = document.getElementById('purpose').value;
            const species = document.getElementById('species').value;

            document.getElementById('maintenance-options').classList.toggle('hidden', purpose !== 'maintenance');
            document.getElementById('growth-options').classList.toggle('hidden', purpose !== 'growth');
            document.getElementById('lactation-options').classList.toggle('hidden', purpose !== 'lactation');
            
            if (purpose === 'growth') {
                const ageStageSelect = document.getElementById('age_stage');
                ageStageSelect.querySelector('option[value="puppy_young"]').disabled = (species === 'cat');
                ageStageSelect.querySelector('option[value="puppy_old"]').disabled = (species === 'cat');
                ageStageSelect.querySelector('option[value="kitten"]').disabled = (species === 'dog');
                if (species === 'cat') {
                    ageStageSelect.value = 'kitten';
                } else if (ageStageSelect.value === 'kitten') {
                    ageStageSelect.value = 'puppy_young';
                }
            }
        }

        function updateTransfusionUI(calculatorId) {
            const species = document.getElementById('tf-species').value;
            const bloodVolumeInput = document.getElementById('tf-blood-volume');
            const infoDiv = document.getElementById('tf-blood-volume-info');
            
            if (species === 'dog') {
                bloodVolumeInput.value = 90;
                infoDiv.innerHTML = '<b>ç´„ 80â€“90 mL/kg:</b> å¤§å‹çŠ¬ã‚„ã‚¹ãƒãƒ¼ãƒ„çŠ¬ã§ã¯ã‚„ã‚„å¤šã‚ã€‚æˆæ›¸ãƒ»è¡€æ¶²ãƒãƒ³ã‚¯æŒ‡é‡ã¨ã‚‚ã«ã“ã®ç¯„å›²ã‚’æ¡ç”¨ã€‚';
            } else { // cat
                bloodVolumeInput.value = 60;
                infoDiv.innerHTML = '<b>ç´„ 50â€“60 mL/kg:</b> å°å‹å‹•ç‰©ã¯ä½“é‡ã‚ãŸã‚Šè¡€æ¶²é‡ãŒå°‘ãªã‚ã€‚ISFMãªã©ã§ã¯55-60mL/kgã‚’åŸºæº–ã«ã™ã‚‹ã“ã¨ãŒå¤šã„ã€‚';
            }
            calculate(calculatorId);
        }

        function calculate(id) {
            const resultBox = document.getElementById(`calc-result-${id}`);
            if (!resultBox) return;
            let resultHtml = '';
            
            try {
                 switch(id) {
                    case 'calorie_dogcat_detailed':
                        const species = document.getElementById('species').value;
                        const bw_kg = parseFloat(document.getElementById('bw_kg').value);
                        if (isNaN(bw_kg) || bw_kg <= 0) throw new Error();
                        
                        const purpose = document.getElementById('purpose').value;
                        const rer_formula = document.getElementById('rer_formula').value;
                        const food_density = parseFloat(document.getElementById('food_density').value);

                        let rer = 0;
                        let rer_formula_text = '';
                        if (rer_formula === 'exponential' || bw_kg < 2 || bw_kg > 45) {
                            rer = 70 * Math.pow(bw_kg, 0.75);
                            rer_formula_text = `RER = 70 * (${bw_kg}^0.75) = ${rer.toFixed(1)} kcal/æ—¥`;
                        } else {
                            rer = 30 * bw_kg + 70;
                            rer_formula_text = `RER = 30 * ${bw_kg} + 70 = ${rer.toFixed(1)} kcal/æ—¥`;
                        }
                        
                        let factor = 1.0;
                        let factor_text = '';
                        
                        switch (purpose) {
                            case 'maintenance':
                                const neuter_status = document.getElementById('neuter_status').value;
                                const obesity_prone = document.getElementById('obesity_prone').checked;
                                if (species === 'dog') {
                                    if (obesity_prone) { factor = 1.4; factor_text = 'è‚¥æº€å‚¾å‘/ä½æ´»å‹•'; }
                                    else if (neuter_status === 'neutered') { factor = 1.6; factor_text = 'å»å‹¢æ¸ˆ'; }
                                    else { factor = 1.8; factor_text = 'æœªå»å‹¢'; }
                                } else { // cat
                                    if (obesity_prone) { factor = 1.0; factor_text = 'è‚¥æº€å‚¾å‘/ä½æ´»å‹•'; }
                                    else if (neuter_status === 'neutered') { factor = 1.2; factor_text = 'å»å‹¢æ¸ˆ'; }
                                    else { factor = 1.4; factor_text = 'æœªå»å‹¢'; }
                                }
                                break;
                            case 'growth':
                                const age_stage = document.getElementById('age_stage').value;
                                if (species === 'dog') {
                                    if (age_stage === 'puppy_young') { factor = 3.0; factor_text = 'æˆé•·æœŸ (<4ãƒ¶æœˆ)'; }
                                    else { factor = 2.0; factor_text = 'æˆé•·æœŸ (>=4ãƒ¶æœˆ)'; }
                                } else { // cat
                                    factor = 2.5; factor_text = 'æˆé•·æœŸ (å­çŒ«)';
                                }
                                break;
                            case 'weight_loss':
                                factor = (species === 'dog') ? 1.0 : 0.8;
                                factor_text = 'æ¸›é‡';
                                break;
                            case 'critical_care':
                                factor = 1.0;
                                factor_text = 'å…¥é™¢/ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«';
                                break;
                            case 'gestation':
                                factor = (species === 'dog') ? 1.8 : 2.0;
                                factor_text = 'å¦Šå¨ æœŸ';
                                break;
                            case 'lactation':
                                const litter_size = parseInt(document.getElementById('litter_size').value) || 0;
                                if (species === 'dog' && litter_size > 0) {
                                    factor = 2.1 + (0.25 * litter_size);
                                    factor_text = `æˆä¹³æœŸ (${litter_size}é ­, ãƒ”ãƒ¼ã‚¯æ™‚ç°¡æ˜“å¼)`;
                                } else {
                                    factor = (species === 'dog') ? 4.0 : 3.0;
                                    factor_text = 'æˆä¹³æœŸ (ä¸€èˆ¬)';
                                }
                                break;
                        }

                        const mer = rer * factor;
                        const foodAmount = !isNaN(food_density) && food_density > 0 ? (mer / food_density) * 100 : 0;
                        
                        resultHtml = `
                            <h4 class="font-semibold text-lg mb-2">è¨ˆç®—çµæœ</h4>
                            <p><strong>å®‰é™æ™‚ã‚¨ãƒãƒ«ã‚®ãƒ¼è¦æ±‚é‡ (RER):</strong> <span class="font-bold text-emerald-700">${rer.toFixed(1)}</span> kcal/æ—¥</p>
                            <p><strong>1æ—¥ã®ç¶­æŒã‚¨ãƒãƒ«ã‚®ãƒ¼è¦æ±‚é‡ (DER/MER):</strong> <span class="font-bold text-emerald-700">${mer.toFixed(1)}</span> kcal/æ—¥</p>
                            ${foodAmount > 0 ? `<p class="text-xl font-bold mt-2 text-emerald-700"><strong>1æ—¥ã®çµ¦ä¸é‡ç›®å®‰:</strong> ${foodAmount.toFixed(1)} g/æ—¥</p>` : ''}
                            <h5 class="font-semibold mt-4 mb-1">è¨ˆç®—éç¨‹</h5>
                            <div class="calc-formula">
${rer_formula_text}
DER/MER = RER * ä¿‚æ•° = ${rer.toFixed(1)} * ${factor.toFixed(1)} (ä¿‚æ•°: ${factor_text}) = ${mer.toFixed(1)} kcal/æ—¥
${foodAmount > 0 ? `çµ¦ä¸é‡ = DER / (ãƒ•ãƒ¼ãƒ‰kcal/100g) * 100 = ${mer.toFixed(1)} / ${food_density} * 100 = ${foodAmount.toFixed(1)} g/æ—¥` : ''}
                            </div>
                            <p class="text-xs text-gray-600 mt-4">æ³¨æ„: ã“ã®è¨ˆç®—å€¤ã¯ã‚ãã¾ã§é–‹å§‹ç‚¹ã§ã™ã€‚å€‹ä½“å·®ãŒå¤§ãã„ãŸã‚ã€2ï½4é€±é–“ã”ã¨ã«ä½“é‡ã¨ãƒœãƒ‡ã‚£ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã‚¹ã‚³ã‚¢ã‚’è©•ä¾¡ã—ã€çµ¦ä¸é‡ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚</p>
                        `;
                        break;
                    
                    case 'bsa':
                        const bsa_weight = parseFloat(document.getElementById('bsa-weight').value);
                        const bsa_species = document.getElementById('bsa-species').value
                        if (isNaN(bsa_weight) || bsa_weight <= 0) throw new Error();
                        const k = bsa_species === 'dog' ? 10.1 : 10.0;
                        const bsa = k * Math.pow(bsa_weight * 1000, 2/3) / 10000;
                        resultHtml = `
                            <h4 class="font-semibold text-lg mb-2">è¨ˆç®—çµæœ</h4>
                            <p class="text-xl font-bold mt-2 text-emerald-700"><strong>ä½“è¡¨é¢ç© (BSA):</strong> ${bsa.toFixed(4)} mÂ²</p>
                            <h5 class="font-semibold mt-4 mb-1">è¨ˆç®—éç¨‹</h5>
                            <div class="calc-formula">
BSA (mÂ²) = (K * (ä½“é‡(g) ^ (2/3))) / 10000
  = (${k} * ((${bsa_weight}*1000) ^ (2/3))) / 10000 = ${bsa.toFixed(4)}
                            </div>
                            <div class="mt-6">
                                <h4 class="font-semibold text-lg mb-2">BSAæ—©è¦‹è¡¨</h4>
                                <div class="table-container">
                                    <table class="custom-table text-sm">
                                        <thead><tr><th>ä½“é‡(kg)</th><th>BSA(mÂ²)</th><th>ä½“é‡(kg)</th><th>BSA(mÂ²)</th><th>ä½“é‡(kg)</th><th>BSA(mÂ²)</th></tr></thead>
                                        <tbody id="bsa-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                            `;
                        break;

                    case 'transfusion':
                        const tf_species = document.getElementById('tf-species').value;
                        const tf_bw = parseFloat(document.getElementById('tf-weight').value);
                        const tf_bv = parseFloat(document.getElementById('tf-blood-volume').value);
                        const pcv_now = parseFloat(document.getElementById('tf-patient-pcv').value);
                        const pcv_target = parseFloat(document.getElementById('tf-target-pcv').value);
                        const pcv_donor = parseFloat(document.getElementById('tf-donor-pcv').value);
                        
                        if ([tf_bw, tf_bv, pcv_now, pcv_target, pcv_donor].some(isNaN) || tf_bw <= 0 || pcv_donor <= 0) throw new Error();

                        const requiredBlood = (tf_bw * tf_bv * (pcv_target - pcv_now)) / pcv_donor;
                        const pcv_rise = pcv_target - pcv_now;
                        const rule_of_thumb_blood = 2 * tf_bw * pcv_rise;
                        const max_draw_rate = tf_species === 'dog' ? 15 : 10;
                        const max_draw_vol = max_draw_rate * tf_bw;

                        resultHtml = `
                            <h4 class="font-semibold text-lg mb-2">è¨ˆç®—çµæœ</h4>
                            <p class="text-xl font-bold mt-2 text-emerald-700"><strong>å¿…è¦è¡€æ¶²é‡:</strong> ${requiredBlood.toFixed(1)} mL</p>
                            <h5 class="font-semibold mt-4 mb-1">è¨ˆç®—éç¨‹</h5>
                            <div class="calc-formula">
å¿…è¦é‡(mL) = (ä½“é‡ * å¾ªç’°è¡€æ¶²é‡ * (ç›®æ¨™PCV - ç¾åœ¨PCV)) / ãƒ‰ãƒŠãƒ¼PCV
  = (${tf_bw} * ${tf_bv} * (${pcv_target} - ${pcv_now})) / ${pcv_donor} = ${requiredBlood.toFixed(1)} mL
                            </div>
                            <div class="mt-6">
                                <h4 class="font-semibold text-lg mb-2">å‚è€ƒæƒ…å ±</h4>
                                <ul class="list-disc pl-5 text-sm space-y-2">
                                    <li><strong>çµŒé¨“å‰‡ã«ã‚ˆã‚‹æ¦‚ç®— (Rule of Thumb):</strong><br>
                                        PCVã‚’${pcv_rise}%ä¸Šã’ã‚‹ã®ã«å¿…è¦ãªå…¨è¡€é‡ã¯ãŠã‚ˆã <strong>${rule_of_thumb_blood.toFixed(0)} mL</strong> ã§ã™ã€‚<br>
                                        <span class="text-xs text-gray-500">(è¨ˆç®—å¼: 2 mL/kg * ${tf_bw} kg * ${pcv_rise}%ä¸Šæ˜‡)</span>
                                    </li>
                                    <li><strong>ãƒ‰ãƒŠãƒ¼ã®å®‰å…¨ãªæ¡è¡€é‡ (ç›®å®‰):</strong><br>
                                        ä½“é‡${tf_bw} kgã®ãƒ‰ãƒŠãƒ¼ã‹ã‚‰ã®1å›ã‚ãŸã‚Šã®å®‰å…¨ãªæ¡è¡€é‡ä¸Šé™ã¯ã€ãŠã‚ˆã <strong>${max_draw_vol.toFixed(0)} mL</strong> ã§ã™ã€‚<br>
                                        <span class="text-xs text-gray-500">(è¨ˆç®—å¼: ${max_draw_rate} mL/kg * ${tf_bw} kg) â€»ãƒ‰ãƒŠãƒ¼ã®å¥åº·çŠ¶æ…‹ãƒ»ä½“é‡ã‚’æ­£ç¢ºã«è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚</span>
                                    </li>
                                </ul>
                            </div>
                            <p class="text-xs text-gray-600 mt-4">æ³¨æ„: è¨ˆç®—å€¤ã¯ç†è«–å€¤ã§ã™ã€‚éè¼¸è¡€ã‚’é¿ã‘ã‚‹ãŸã‚ã€æ‚£è€…ã®çŠ¶æ…‹ï¼ˆç‰¹ã«å¿ƒç–¾æ‚£ã‚„è…ç–¾æ‚£ã®æœ‰ç„¡ï¼‰ã‚’è€ƒæ…®ã—ã€ã¾ãšã¯è¨ˆç®—é‡ã®25-50%ã‚’æŠ•ä¸ã—ã¦åå¿œã‚’è¦‹ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚</p>
                            `;
                        break;
                    case 'medication_exotic_oral':
                        const med_exo_weight_kg = parseFloat(document.getElementById('med-exo-weight').value) / 1000;
                        const med_exo_dose = parseFloat(document.getElementById('med-exo-dose').value);
                        const med_exo_strength = parseFloat(document.getElementById('med-exo-strength').value);
                        const med_exo_drops = parseFloat(document.getElementById('med-exo-drops').value);

                        if ([med_exo_weight_kg, med_exo_dose, med_exo_strength, med_exo_drops].some(isNaN) || med_exo_weight_kg <= 0 || med_exo_strength <= 0 || med_exo_drops <= 0) throw new Error();

                        const requiredDoseMg = med_exo_weight_kg * med_exo_dose;
                        const doseVolumeMl = med_exo_drops * 0.05; // 1 drop â‰ˆ 0.05mL
                        const requiredConc = requiredDoseMg / doseVolumeMl;
                        const waterVolume = med_exo_strength / requiredConc;

                        resultHtml = `
                            <h4 class="font-semibold text-lg mb-2">è¨ˆç®—çµæœ</h4>
                            <p><strong>1å›ã«å¿…è¦ãªè–¬å‰¤é‡:</strong> ${requiredDoseMg.toFixed(3)} mg</p>
                            <p><strong>ç›®æ¨™ã¨ã™ã‚‹æŠ•ä¸æ¶²é‡:</strong> ${doseVolumeMl.toFixed(3)} mL (${med_exo_drops} æ»´)</p>
                            <p><strong>å¿…è¦ãªè–¬æ¶²æ¿ƒåº¦:</strong> ${requiredConc.toFixed(2)} mg/mL</p>
                            <p class="text-xl font-bold mt-2 text-emerald-700"><strong>${med_exo_strength}mgã®è–¬å‰¤1éŒ </strong>ã‚’ <strong>${waterVolume.toFixed(2)} mL</strong> ã®æ°´ã«æº¶è§£ã—ã¦ãã ã•ã„ã€‚</p>
                            <h5 class="font-semibold mt-4 mb-1">è¨ˆç®—éç¨‹</h5>
                            <div class="calc-formula">
1å›ã«å¿…è¦ãªè–¬å‰¤é‡(mg) = ä½“é‡(kg) * æŠ•ä¸é‡(mg/kg)
  = ${med_exo_weight_kg.toFixed(3)} * ${med_exo_dose} = ${requiredDoseMg.toFixed(3)}

ç›®æ¨™æŠ•ä¸æ¶²é‡(mL) = ç›®æ¨™æ»´ä¸‹æ•° * 0.05
  = ${med_exo_drops} * 0.05 = ${doseVolumeMl.toFixed(3)}

å¿…è¦ãªè–¬æ¶²æ¿ƒåº¦(mg/mL) = å¿…è¦ãªè–¬å‰¤é‡(mg) / ç›®æ¨™æŠ•ä¸æ¶²é‡(mL)
  = ${requiredDoseMg.toFixed(3)} / ${doseVolumeMl.toFixed(3)} = ${requiredConc.toFixed(2)}

æº¶è§£ã«å¿…è¦ãªæ°´ã®é‡(mL) = è–¬å‰¤ã®å«æœ‰é‡(mg) / å¿…è¦ãªè–¬æ¶²æ¿ƒåº¦(mg/mL)
  = ${med_exo_strength} / ${requiredConc.toFixed(2)} = ${waterVolume.toFixed(2)}
                            </div>`;
                        break;
                    case 'medication_exotic_water':
                        const activeTab = document.querySelector('#water-med-tabs a.border-emerald-500').dataset.tab;
                        if (activeTab === 'from_dose') {
                            const wm_fd_weight_kg = parseFloat(document.getElementById('wm-fd-weight').value) / 1000;
                            const wm_fd_dose = parseFloat(document.getElementById('wm-fd-dose').value);
                            const wm_fd_intake_L = parseFloat(document.getElementById('wm-fd-intake').value) / 1000;
                            const wm_fd_strength = parseFloat(document.getElementById('wm-fd-strength').value);
                            const wm_fd_volume_L = parseFloat(document.getElementById('wm-fd-volume').value) / 1000;
                            const wm_fd_days = parseInt(document.getElementById('wm-fd-days').value);
                            
                            if ([wm_fd_weight_kg, wm_fd_dose, wm_fd_intake_L, wm_fd_strength, wm_fd_volume_L, wm_fd_days].some(isNaN) || wm_fd_weight_kg <= 0 || wm_fd_intake_L <= 0 || wm_fd_strength <= 0 || wm_fd_volume_L <= 0 || wm_fd_days <= 0) throw new Error();

                            const dailyDoseMg = wm_fd_weight_kg * wm_fd_dose;
                            const targetConc = dailyDoseMg / wm_fd_intake_L;
                            const drugPerBottle = targetConc * wm_fd_volume_L;
                            const totalDrug = drugPerBottle * wm_fd_days;
                            const totalTablets = totalDrug / wm_fd_strength;

                            resultHtml = `
                                <h4 class="font-semibold text-lg mb-2">è¨ˆç®—çµæœ</h4>
                                <p><strong>ç›®æ¨™æ¿ƒåº¦:</strong> ${targetConc.toFixed(2)} mg/L</p>
                                <p class="text-xl font-bold mt-2 text-emerald-700">è–¬å‰¤ <strong>${totalTablets.toFixed(2)} éŒ (or g)</strong> ã‚’ <strong>${wm_fd_days}åŒ…</strong> ã«åˆ†ã‘ã€<br>1åŒ…ã‚’1æ—¥1å›ã€é£²æ°´ ${wm_fd_volume_L * 1000} mLã«æ··ãœã¦æŠ•ä¸ã—ã¾ã™ã€‚</p>
                                <h5 class="font-semibold mt-4 mb-1">è¨ˆç®—éç¨‹</h5>
                                <div class="calc-formula">
1æ—¥ã®å¿…è¦è–¬å‰¤é‡(mg) = ä½“é‡(kg) * æŠ•ä¸é‡(mg/kg/æ—¥) = ${dailyDoseMg.toFixed(3)}
ç›®æ¨™æ¿ƒåº¦(mg/L) = 1æ—¥ã®å¿…è¦è–¬å‰¤é‡(mg) / 1æ—¥ã®é£²æ°´é‡(L) = ${targetConc.toFixed(2)}
1åŒ…ã‚ãŸã‚Šã®è–¬å‰¤é‡(mg) = ç›®æ¨™æ¿ƒåº¦(mg/L) * æº¶è§£ã™ã‚‹æ°´ã®é‡(L) = ${drugPerBottle.toFixed(3)}
ç·è–¬å‰¤é‡(mg) = 1åŒ…ã‚ãŸã‚Šã®è–¬å‰¤é‡(mg) * æŠ•ä¸æ—¥æ•° = ${totalDrug.toFixed(3)}
ç·éŒ å‰¤æ•°(éŒ ) = ç·è–¬å‰¤é‡(mg) / è–¬å‰¤ã®å«æœ‰é‡(mg) = ${totalTablets.toFixed(2)}
                                </div>`;

                        } else { // from_conc
                            const wm_fc_conc = parseFloat(document.getElementById('wm-fc-conc').value);
                            const wm_fc_strength = parseFloat(document.getElementById('wm-fc-strength').value);
                            const wm_fc_volume_L = parseFloat(document.getElementById('wm-fc-volume').value) / 1000;
                            const wm_fc_days = parseInt(document.getElementById('wm-fc-days').value);

                            if ([wm_fc_conc, wm_fc_strength, wm_fc_volume_L, wm_fc_days].some(isNaN) || wm_fc_conc <= 0 || wm_fc_strength <= 0 || wm_fc_volume_L <= 0 || wm_fc_days <= 0) throw new Error();
                            
                            const drugPerBottle_fc = wm_fc_conc * wm_fc_volume_L;
                            const totalDrug_fc = drugPerBottle_fc * wm_fc_days;
                            const totalTablets_fc = totalDrug_fc / wm_fc_strength;

                             resultHtml = `
                                <h4 class="font-semibold text-lg mb-2">è¨ˆç®—çµæœ</h4>
                                <p class="text-xl font-bold mt-2 text-emerald-700">è–¬å‰¤ <strong>${totalTablets_fc.toFixed(2)} éŒ (or g)</strong> ã‚’ <strong>${wm_fc_days}åŒ…</strong> ã«åˆ†ã‘ã€<br>1åŒ…ã‚’1æ—¥1å›ã€é£²æ°´ ${wm_fc_volume_L * 1000} mLã«æ··ãœã¦æŠ•ä¸ã—ã¾ã™ã€‚</p>
                                <h5 class="font-semibold mt-4 mb-1">è¨ˆç®—éç¨‹</h5>
                                <div class="calc-formula">
1åŒ…ã‚ãŸã‚Šã®è–¬å‰¤é‡(mg) = ç›®æ¨™æ¿ƒåº¦(mg/L) * æº¶è§£ã™ã‚‹æ°´ã®é‡(L) = ${drugPerBottle_fc.toFixed(3)}
ç·è–¬å‰¤é‡(mg) = 1åŒ…ã‚ãŸã‚Šã®è–¬å‰¤é‡(mg) * æŠ•ä¸æ—¥æ•° = ${totalDrug_fc.toFixed(3)}
ç·éŒ å‰¤æ•°(éŒ ) = ç·è–¬å‰¤é‡(mg) / è–¬å‰¤ã®å«æœ‰é‡(mg) = ${totalTablets_fc.toFixed(2)}
                                </div>`;
                        }
                        break;
                }
                resultBox.innerHTML = resultHtml;
                resultBox.classList.remove('hidden');

                if (id === 'bsa') {
                    generateBsaTable(document.getElementById('bsa-species').value);
                }

            } catch (e) {
                resultBox.classList.add('hidden');
            }
        }

        function generateBsaTable(species) {
            const tableBody = document.getElementById('bsa-table-body');
            if (!tableBody) return;
            const k = species === 'dog' ? 10.1 : 10.0;
            const weights = [1,2,3,4,5,6,7,8,9,10,12,14,16,18,20,25,30,35,40,45,50,55,60];
            let tableHtml = '';
            for(let i = 0; i < weights.length; i += 3) {
                tableHtml += '<tr>';
                for(let j = 0; j < 3; j++) {
                    const weight = weights[i+j];
                    if(weight) {
                        const bsa = k * Math.pow(weight * 1000, 2/3) / 10000;
                        tableHtml += `<td><strong>${weight}kg</strong></td><td>${bsa.toFixed(3)} mÂ²</td>`;
                    } else {
                        tableHtml += '<td></td><td></td>';
                    }
                }
                tableHtml += '</tr>';
            }
            tableBody.innerHTML = tableHtml;
        }

        init();

    </script>
</body>
</html>
